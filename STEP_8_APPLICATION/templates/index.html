<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groundwater Level Prediction - Nashik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Draw Plugin -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        /* Enhanced Map Styling */
        #map { 
            height: 500px !important; 
            width: 100% !important;
            border-radius: 1rem; 
            border: 2px solid #e5e7eb;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 1;
            position: relative;
        }
        
        #map:hover {
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }
        
        /* Ensure Leaflet map fills container */
        .leaflet-container {
            height: 100% !important;
            width: 100% !important;
            z-index: 1;
        }
        
        /* Search dropdown z-index */
        #suggestionsDropdown {
            z-index: 9999 !important;
            position: absolute;
        }
        
        /* Prevent text selection in suggestion items for better clicking */
        .suggestion-item {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        
        .suggestion-item * {
            pointer-events: none; /* Make child elements not capture clicks */
        }
        
        /* Ensure search section doesn't overlap */
        #search {
            position: relative;
            z-index: 100;
            margin-bottom: 3rem;
        }
        
        /* Map section positioning */
        #mapSection {
            position: relative;
            z-index: 1;
            margin-top: 2rem;
        }
        
        /* Smooth Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        
        .animate-slideInRight {
            animation: slideInRight 0.5s ease-out forwards;
        }
        
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* Glass morphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        /* Gradient backgrounds */
        .gradient-water {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-nature {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .gradient-ocean {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        /* Button hover effects */
        .btn-hover {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-hover:hover::before {
            left: 100%;
        }
        
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        }
        
        /* Card hover effects */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #764ba2 0%, #667eea 100%);
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        /* Mobile responsive utilities */
        @media (max-width: 768px) {
            #map {
                height: 350px;
            }
        }
        
        /* Smooth page transitions */
        .page-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        
        .page-section.visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    
    <script>
        // Tailwind config for custom colors and dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                        accent: '#4facfe',
                        water: '#00f2fe',
                        nature: '#10b981',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-cyan-50 to-teal-50 dark:from-gray-900 dark:via-slate-900 dark:to-gray-800 min-h-screen transition-colors duration-300">
    <!-- Professional Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass backdrop-blur-lg border-b border-white/20 dark:bg-gray-900/90 dark:border-gray-700/50 transition-colors">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center space-x-3 animate-fadeInUp">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 dark:from-blue-400 dark:to-cyan-400 bg-clip-text text-transparent">
                            Groundwater AI
                        </h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Nashik District</p>
                    </div>
                </div>
                
                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-6">
                    <a href="#search" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Search</a>
                    <a href="#map" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Map</a>
                    <a href="#predictions" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Predictions</a>
                    <button id="darkModeToggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>
                </div>
                
                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="md:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700 dark:text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden border-t border-white/20 dark:border-gray-700">
            <div class="px-4 py-4 space-y-3 bg-white/50 dark:bg-gray-900/90 backdrop-blur-lg">
                <a href="#search" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Search</a>
                <a href="#map" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Map</a>
                <a href="#predictions" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Predictions</a>
            </div>
        </div>
    </nav>
    
    <!-- Main Content Container -->
    <div class="pt-24 pb-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Hero Header -->
            <div class="text-center mb-12 animate-fadeInUp">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold mb-4">
                    <span class="bg-gradient-to-r from-blue-600 via-cyan-500 to-teal-500 dark:from-blue-400 dark:via-cyan-400 dark:to-teal-400 bg-clip-text text-transparent">
                        Groundwater Level Prediction
                    </span>
                </h1>
                <p class="text-lg sm:text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
                    AI-powered groundwater analysis for Nashik District using real-time data and machine learning
                </p>
                <div class="mt-6 flex flex-wrap justify-center gap-4">
                    <div class="inline-flex items-center px-4 py-2 bg-green-100 dark:bg-green-900/30 rounded-full">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse-slow mr-2"></span>
                        <span class="text-sm font-medium text-green-700 dark:text-green-400">Live Weather Data</span>
                    </div>
                    <div class="inline-flex items-center px-4 py-2 bg-purple-100 dark:bg-purple-900/30 rounded-full">
                        <span class="w-2 h-2 bg-purple-500 rounded-full animate-pulse-slow mr-2"></span>
                        <span class="text-sm font-medium text-purple-700 dark:text-purple-400">AI Recommendations</span>
                    </div>
                    <div class="inline-flex items-center px-4 py-2 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                        <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse-slow mr-2"></span>
                        <span class="text-sm font-medium text-blue-700 dark:text-blue-400">30+ Borewells</span>
                    </div>
                </div>
            </div>
            
            <!-- Main Card -->
            <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl overflow-hidden animate-fadeInUp transition-colors" style="animation-delay: 0.2s;">
                <div class="p-6 sm:p-8 lg:p-10">
                
                    <!-- Enhanced Search Box with Autocomplete -->
                    <div id="search" class="mb-8 relative page-section">
            <div class="flex items-center mb-4">
                <div class="p-3 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl shadow-lg mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Search Location</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Find groundwater data for Nashik District</p>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3">
                <div class="flex-1 relative group">
                    <input 
                        type="text" 
                        id="locationSearch" 
                        placeholder="Type location & press Enter (e.g., Nashik, Mumbai)..." 
                        autocomplete="off"
                        class="w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-lg text-base py-4 pl-14 pr-12 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all duration-300 hover:shadow-xl">
                    <!-- Search icon -->
                    <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 group-focus-within:text-blue-500 dark:group-focus-within:text-blue-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <!-- Clear button -->
                    <button type="button" id="clearSearchBtn" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-all hover:scale-110 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    
                    <!-- Autocomplete Suggestions Dropdown -->
                    <div id="suggestionsDropdown" class="absolute w-full mt-2 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 hidden max-h-96 overflow-y-auto transition-colors" style="z-index: 99999 !important; position: absolute !important;">
                        <div id="suggestionsList"></div>
                    </div>
                </div>
                <button type="button" id="searchBtn" class="bg-gradient-to-r from-blue-600 to-cyan-600 dark:from-blue-500 dark:to-cyan-500 text-white py-4 px-8 rounded-xl hover:from-blue-700 hover:to-cyan-700 dark:hover:from-blue-600 dark:hover:to-cyan-600 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl btn-hover flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <span class="hidden sm:inline">Search</span>
                </button>
            </div>
            
            <!-- Place Category Filters -->
            <div class="mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl border border-purple-100 dark:border-purple-800">
                <div class="flex items-center gap-2 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    <span class="font-semibold text-gray-800 dark:text-gray-100">Search by Category:</span>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-purple-500 dark:hover:border-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/30 transition-all duration-200 text-sm font-medium" data-category="all">
                        üåç All Places
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-all duration-200 text-sm font-medium" data-category="city">
                        üèôÔ∏è Cities/Towns
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-green-500 dark:hover:border-green-400 hover:bg-green-50 dark:hover:bg-green-900/30 transition-all duration-200 text-sm font-medium" data-category="village">
                        üèòÔ∏è Villages
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-yellow-500 dark:hover:border-yellow-400 hover:bg-yellow-50 dark:hover:bg-yellow-900/30 transition-all duration-200 text-sm font-medium" data-category="school">
                        üéì Schools
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-indigo-500 dark:hover:border-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-all duration-200 text-sm font-medium" data-category="bank">
                        üè¶ Banks
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-pink-500 dark:hover:border-pink-400 hover:bg-pink-50 dark:hover:bg-pink-900/30 transition-all duration-200 text-sm font-medium" data-category="shop">
                        üõçÔ∏è Shops
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-red-500 dark:hover:border-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 transition-all duration-200 text-sm font-medium" data-category="hospital">
                        üè• Hospitals
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-orange-500 dark:hover:border-orange-400 hover:bg-orange-50 dark:hover:bg-orange-900/30 transition-all duration-200 text-sm font-medium" data-category="temple">
                        üïâÔ∏è Temples
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-teal-500 dark:hover:border-teal-400 hover:bg-teal-50 dark:hover:bg-teal-900/30 transition-all duration-200 text-sm font-medium" data-category="restaurant">
                        üçΩÔ∏è Restaurants
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-cyan-500 dark:hover:border-cyan-400 hover:bg-cyan-50 dark:hover:bg-cyan-900/30 transition-all duration-200 text-sm font-medium" data-category="hotel">
                        üè® Hotels
                    </button>
                </div>
            </div>
            
            <div id="searchResults" class="mt-3 text-sm"></div>
            
            <!-- Quick Tips -->
            <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800">
                <div class="flex flex-wrap gap-4 text-xs text-gray-600 dark:text-gray-300">
                    <span class="flex items-center gap-2">
                        <span class="p-1.5 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </span>
                        <span>Click search box to see 50+ locations</span>
                    </span>
                    <span class="flex items-center gap-2">
                        <span class="p-1.5 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" />
                            </svg>
                        </span>
                        <span>Use ‚Üë‚Üì arrows to navigate suggestions</span>
                    </span>
                </div>
            </div>
                    </div>

                    <!-- Spacer -->
                    <div class="h-8"></div>

                    <!-- Map Section -->
                    <div id="mapSection" class="mb-8 page-section">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-4">
                <div class="flex items-center">
                    <div class="p-3 bg-gradient-to-br from-green-500 to-teal-500 rounded-xl shadow-lg mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Interactive Map</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Click or draw area to select location</p>
                    </div>
                </div>
                <button type="button" id="useMyLocationBtn" class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-3 px-5 rounded-xl hover:from-blue-700 hover:to-cyan-700 transition-all duration-300 font-semibold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl btn-hover">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Use My GPS Location
                </button>
            </div>
            
            <div class="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 rounded-xl border border-blue-100 dark:border-blue-800 mb-4">
                <p class="text-sm text-gray-700 dark:text-gray-200 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span><strong>Tip:</strong> Click anywhere on map OR use the rectangle tool (‚ñ°) to draw a selection area</span>
                </p>
            </div>
            
            <div id="locationStatus" class="mb-3 text-sm font-medium hidden"></div>
            
            <!-- Borewell Toggle Buttons -->
            <div class="mb-4 flex flex-wrap gap-3">
                <button type="button" id="showBorewellsBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 px-5 rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all duration-300 font-semibold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl btn-hover">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    Show 30+ Existing Borewells
                </button>
                <button type="button" id="hideBorewellsBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 px-5 rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-300 font-semibold text-sm flex items-center gap-2 shadow-lg hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                    </svg>
                    Hide Borewells
                </button>
            </div>
                        <div id="borewellStatus" class="mb-3 text-sm font-medium hidden"></div>
                        
                        <!-- Map Container with proper styling -->
                        <div id="map" class="w-full rounded-2xl overflow-hidden shadow-lg border-2 border-gray-200" style="height: 500px;"></div>
                        
                        <!-- Area Prediction Button -->
                        <button type="button" id="predictAreaBtn" class="mt-4 w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-4 px-6 rounded-xl hover:from-green-700 hover:to-teal-700 transition-all duration-300 text-lg font-semibold hidden flex items-center justify-center gap-3 shadow-lg hover:shadow-xl btn-hover">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                            </svg>
                            <span>Predict Groundwater Levels in Selected Area</span>
                            <span class="bg-yellow-400 text-gray-900 text-xs px-3 py-1 rounded-full font-bold">LIVE DATA</span>
                        </button>
                        <div id="areaPredictionStatus" class="mt-3 text-center text-sm font-medium hidden"></div>
                    </div>

                    <!-- Weather Information Panel -->
                    <div id="weatherPanel" class="mb-8 bg-gradient-to-br from-blue-50 via-cyan-50 to-teal-50 dark:from-blue-900/20 dark:via-cyan-900/20 dark:to-teal-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-2xl p-6 shadow-xl hidden card-hover page-section">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-3">
                <div class="flex items-center">
                    <div class="p-3 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl shadow-lg mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Real-Time Weather Data</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Live from IMD & WRIS stations</p>
                    </div>
                </div>
                <span class="flex items-center gap-2 bg-green-500 text-white text-sm font-semibold px-4 py-2 rounded-full shadow-lg">
                    <span class="w-2 h-2 bg-white rounded-full animate-pulse-slow"></span>
                    LIVE DATA
                </span>
            </div>
            
            <div id="weatherContent">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-600 dark:text-gray-300 text-sm font-semibold">Rainfall</span>
                            <span class="text-3xl">üåßÔ∏è</span>
                        </div>
                        <div id="weatherRainfall" class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 dark:from-blue-400 dark:to-cyan-400 bg-clip-text text-transparent">--</div>
                        <div class="text-gray-500 dark:text-gray-400 text-sm mt-1 font-medium">millimeters</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-600 dark:text-gray-300 text-sm font-semibold">Temperature</span>
                            <span class="text-3xl">üå°Ô∏è</span>
                        </div>
                        <div id="weatherTemp" class="text-3xl font-bold bg-gradient-to-r from-orange-600 to-red-600 dark:from-orange-400 dark:to-red-400 bg-clip-text text-transparent">--</div>
                        <div class="text-gray-500 dark:text-gray-400 text-sm mt-1 font-medium">degrees Celsius</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-600 dark:text-gray-300 text-sm font-semibold">River Level</span>
                            <span class="text-3xl">üíß</span>
                        </div>
                        <div id="weatherRiver" class="text-3xl font-bold bg-gradient-to-r from-cyan-600 to-blue-600 dark:from-cyan-400 dark:to-blue-400 bg-clip-text text-transparent">--</div>
                        <div class="text-gray-500 dark:text-gray-400 text-sm mt-1 font-medium">meters</div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg mb-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="flex flex-col">
                            <span class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">üìÖ Season</span>
                            <span id="weatherSeason" class="text-blue-600 dark:text-blue-400 font-bold text-lg">--</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">üì° Data Source</span>
                            <span id="weatherSource" class="text-gray-700 dark:text-gray-200 font-semibold text-sm">IMD/WRIS (Nashik)</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">üïê Last Updated</span>
                            <span id="weatherTimestamp" class="text-gray-700 dark:text-gray-200 font-semibold text-sm">--</span>
                        </div>
                    </div>
                </div>
                
                <div id="nearestStations" class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg hidden">
                    <div class="font-bold text-gray-800 dark:text-gray-100 mb-3 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        </svg>
                        Nearest Weather Stations
                    </div>
                    <div id="stationsList" class="text-sm text-gray-600 dark:text-gray-300 space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Prediction Form -->
                    <form method="POST" action="/" id="predictionForm" class="space-y-6 page-section">
            <div id="predictions" class="flex items-center mb-6">
                <div class="p-3 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl shadow-lg mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Prediction Parameters</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Auto-filled from real-time data</p>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label for="latitude" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">üìç Latitude</label>
                    <input type="number" step="any" name="latitude" id="latitude" required readonly
                           placeholder="Select on map"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
                <div>
                    <label for="longitude" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">üìç Longitude</label>
                    <input type="number" step="any" name="longitude" id="longitude" required readonly
                           placeholder="Select on map"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label for="rainfall" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">üåßÔ∏è Rainfall (mm)</label>
                    <input type="number" step="any" name="rainfall" id="rainfall" required readonly
                           placeholder="0.00"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
                <div>
                    <label for="river_water_level" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">üíß River Water Level (m)</label>
                    <input type="number" step="any" name="river_water_level" id="river_water_level" required readonly
                           placeholder="0.00"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label for="temperature" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">üå°Ô∏è Temperature (¬∞C)</label>
                    <input type="number" step="any" name="temperature" id="temperature" required readonly
                           placeholder="0.00"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
                <div>
                    <label for="rainfall_lag1" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">üåßÔ∏è Rainfall Lag1 (mm)</label>
                    <input type="number" step="any" name="rainfall_lag1" id="rainfall_lag1" required readonly
                           placeholder="0.00"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label for="river_lag1" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">üíß River Lag1 (m)</label>
                    <input type="number" step="any" name="river_lag1" id="river_lag1" required readonly
                           placeholder="0.00"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
                <div>
                    <label for="data_time" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">üìÖ Data Time</label>
                    <input type="text" name="data_time" id="data_time" required readonly
                           placeholder="2025-09-18 19:42"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
            </div>
            <button type="submit" id="predictButton" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 px-6 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 text-lg font-bold shadow-lg hover:shadow-2xl btn-hover flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span>Predict Groundwater Level</span>
            </button>
            
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="hidden text-center mt-6">
                <div class="flex items-center justify-center gap-3 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-xl">
                    <svg class="animate-spin h-7 w-7 text-blue-600 dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-blue-700 dark:text-blue-300 font-semibold text-lg">Analyzing groundwater data...</span>
                </div>
            </div>
        </form>

        <!-- Prediction Result Container (Dynamic - No Page Refresh) -->
        <div id="predictionResultContainer" class="hidden mt-8"></div>
                    
                </div>
            </div>
    
    <!-- Footer -->
    <footer class="mt-12 pb-8 text-center text-gray-600 dark:text-gray-400 transition-colors">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4 p-6 bg-white rounded-2xl shadow-lg">
                <div class="text-left">
                    <p class="font-semibold text-gray-800">Groundwater AI - Nashik District</p>
                    <p class="text-sm text-gray-500">Powered by Machine Learning & Real-Time Data</p>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-600">Last Updated:</span>
                    <span id="lastUpdated" class="text-sm font-semibold text-blue-600">--</span>
                </div>
            </div>
            <p class="mt-4 text-sm">¬© 2025 Groundwater Prediction System. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const htmlElement = document.documentElement;
        
        // Check for saved theme preference or default to light mode
        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            htmlElement.classList.add('dark');
        }
        
        // Update dark mode button icon
        function updateDarkModeIcon() {
            const isDark = htmlElement.classList.contains('dark');
            darkModeToggle.innerHTML = isDark 
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                     <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" />
                   </svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                   </svg>`;
        }
        
        updateDarkModeIcon();
        
        // Toggle dark mode
        darkModeToggle.addEventListener('click', function() {
            htmlElement.classList.toggle('dark');
            const theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            updateDarkModeIcon();
        });
        
        // Mobile Menu Toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('hidden');
        });
        
        // Smooth scroll for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Close mobile menu if open
                    document.getElementById('mobileMenu').classList.add('hidden');
                }
            });
        });
        
        // Intersection Observer for fade-in animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);
        
        // Observe all page sections
        document.querySelectorAll('.page-section').forEach(section => {
            observer.observe(section);
        });
        
        // Update last updated timestamp
        document.getElementById('lastUpdated').textContent = new Date().toLocaleString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Initialize Leaflet map centered on Nashik (20.0, 73.79)
        const map = L.map('map').setView([20.0, 73.79], 13);
        
        // Satellite view with labels - shows buildings, roads, trees, terrain
        L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            attribution: '&copy; <a href="https://www.google.com/maps">Google Maps</a>',
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        // Layer for drawn items
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Add drawing controls (only rectangle)
        const drawControl = new L.Control.Draw({
            draw: {
                rectangle: {
                    shapeOptions: {
                        color: '#4F46E5',
                        weight: 3,
                        fillOpacity: 0.2
                    }
                },
                polygon: false,
                polyline: false,
                circle: false,
                circlemarker: false,
                marker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        // Marker for selected location
        let marker = null;
        let accuracyCircle = null; // Track GPS accuracy circle
        let locationRing = null; // Track inner location ring for better visibility
        let currentRectangleBounds = null;
        let predictionMarkers = [];
        let boundaryLayer = null;
        let borewellMarkers = [];
        let borewellsVisible = false;

        // Generate random values for other parameters
        function generateRandomParams() {
            const randomInRange = (min, max) => (Math.random() * (max - min) + min).toFixed(2);
            document.getElementById('rainfall').value = randomInRange(0, 100); // Rainfall: 0-100 mm
            document.getElementById('river_water_level').value = randomInRange(0, 10); // River Water Level: 0-10 m
            document.getElementById('temperature').value = randomInRange(15, 35); // Temperature: 15-35¬∞C
            document.getElementById('rainfall_lag1').value = randomInRange(0, 100); // Rainfall Lag1: 0-100 mm
            document.getElementById('river_lag1').value = randomInRange(0, 10); // River Lag1: 0-10 m

            // Set Data Time to current date/time
            const now = new Date();
            const dateTimeStr = now.toISOString().slice(0, 16).replace('T', ' ');
            document.getElementById('data_time').value = dateTimeStr;
        }

        // Clear prediction markers
        function clearPredictionMarkers() {
            predictionMarkers.forEach(m => map.removeLayer(m));
            predictionMarkers = [];
        }

        // Handle rectangle drawn event
        map.on(L.Draw.Event.CREATED, function(e) {
            const layer = e.layer;
            drawnItems.clearLayers(); // Clear previous rectangles
            clearPredictionMarkers(); // Clear old prediction markers
            drawnItems.addLayer(layer);

            // Store bounds for area prediction
            currentRectangleBounds = layer.getBounds();

            // Show area prediction button
            document.getElementById('predictAreaBtn').classList.remove('hidden');
            document.getElementById('areaPredictionStatus').classList.add('hidden');

            // Get center of rectangle
            const bounds = layer.getBounds();
            const center = bounds.getCenter();
            const lat = center.lat.toFixed(6);
            const lng = center.lng.toFixed(6);

            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            // Generate random parameters
            generateRandomParams();

            // Add or update marker at center
            if (marker) {
                marker.setLatLng(center);
            } else {
                marker = L.marker(center, {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
            }
        });

        // Update lat/lng and generate random params on map click
        map.on('click', function(e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            // Generate random parameters after map click
            generateRandomParams();

            // Remove GPS accuracy circle when manually clicking
            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
                accuracyCircle = null;
            }

            // Update or add marker
            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng).addTo(map);
            }
            
            // Auto-load borewells within 20km of clicked location
            autoLoadNearbyBorewells(parseFloat(lat), parseFloat(lng), `(${lat}, ${lng})`);
        });

        // Handle form submission with AJAX (No page refresh!)
        document.getElementById('predictionForm').addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevent form from submitting and refreshing page
            
            // Show loading, hide button
            document.getElementById('predictButton').disabled = true;
            document.getElementById('predictButton').innerHTML = `
                <svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Predicting...</span>
            `;
            document.getElementById('loadingSpinner').classList.remove('hidden');
            
            // Hide any previous results
            document.getElementById('predictionResultContainer').classList.add('hidden');
            
            try {
                // Collect form data
                const formData = new FormData(this);
                
                // Send AJAX request
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // Hide loading
                document.getElementById('loadingSpinner').classList.add('hidden');
                
                // Reset button
                document.getElementById('predictButton').disabled = false;
                document.getElementById('predictButton').innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>Predict Groundwater Level</span>
                `;
                
                // Display result
                const resultContainer = document.getElementById('predictionResultContainer');
                
                if (result.success) {
                    // Success - Show prediction
                    resultContainer.innerHTML = `
                        <div class="p-6 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-2xl border-2 border-green-300 dark:border-green-700 shadow-lg animate-fadeInUp">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="p-3 bg-green-500 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-green-800 dark:text-green-300">Prediction Complete</h3>
                                    <p class="text-sm text-green-600 dark:text-green-400">
                                        AI model confidence: <span id="confidence-value">${result.confidence}%</span>
                                        <span class="ml-2" id="confidence-indicator"></span>
                                    </p>
                                </div>
                            </div>
                            <p class="text-green-900 dark:text-green-100 font-bold text-2xl">
                                Predicted Groundwater Level: 
                                <span class="text-3xl bg-gradient-to-r from-green-600 to-emerald-600 dark:from-green-400 dark:to-emerald-400 bg-clip-text text-transparent">
                                    ${result.prediction} meters
                                </span>
                            </p>
                        </div>
                    `;
                    resultContainer.classList.remove('hidden');
                    
                    // Add confidence indicator with color coding
                    setTimeout(() => {
                        const confidenceValue = result.confidence;
                        const confidenceIndicator = document.getElementById('confidence-indicator');
                        
                        if (confidenceValue >= 90) {
                            confidenceIndicator.innerHTML = 'üü¢ Excellent';
                            confidenceIndicator.className = 'ml-2 text-green-600 dark:text-green-400 font-semibold';
                        } else if (confidenceValue >= 80) {
                            confidenceIndicator.innerHTML = 'üü° Very Good';
                            confidenceIndicator.className = 'ml-2 text-yellow-600 dark:text-yellow-400 font-semibold';
                        } else if (confidenceValue >= 70) {
                            confidenceIndicator.innerHTML = 'üü† Good';
                            confidenceIndicator.className = 'ml-2 text-orange-600 dark:text-orange-400 font-semibold';
                        } else if (confidenceValue >= 60) {
                            confidenceIndicator.innerHTML = 'üü§ Fair';
                            confidenceIndicator.className = 'ml-2 text-amber-700 dark:text-amber-500 font-semibold';
                        } else {
                            confidenceIndicator.innerHTML = 'üî¥ Low';
                            confidenceIndicator.className = 'ml-2 text-red-600 dark:text-red-400 font-semibold';
                        }
                    }, 100);
                    
                    // Scroll to result smoothly
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                } else {
                    // Error - Show error message
                    resultContainer.innerHTML = `
                        <div class="p-6 bg-gradient-to-r from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 rounded-2xl border-2 border-red-300 dark:border-red-700 shadow-lg animate-fadeInUp">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="p-3 bg-red-500 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-red-800 dark:text-red-300">Error Occurred</h3>
                                </div>
                            </div>
                            <p class="text-red-900 dark:text-red-100 font-semibold text-lg">${result.error}</p>
                        </div>
                    `;
                    resultContainer.classList.remove('hidden');
                    
                    // Scroll to error
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                
            } catch (error) {
                console.error('Prediction error:', error);
                
                // Hide loading
                document.getElementById('loadingSpinner').classList.add('hidden');
                
                // Reset button
                document.getElementById('predictButton').disabled = false;
                document.getElementById('predictButton').innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>Predict Groundwater Level</span>
                `;
                
                // Show error
                const resultContainer = document.getElementById('predictionResultContainer');
                resultContainer.innerHTML = `
                    <div class="p-6 bg-gradient-to-r from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 rounded-2xl border-2 border-red-300 dark:border-red-700 shadow-lg">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="p-3 bg-red-500 rounded-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-red-800 dark:text-red-300">Network Error</h3>
                            </div>
                        </div>
                        <p class="text-red-900 dark:text-red-100 font-semibold text-lg">Failed to connect to server. Please check your connection and try again.</p>
                    </div>
                `;
                resultContainer.classList.remove('hidden');
            }
        });

        // GPS Location Handler - Use My Location Button
        document.getElementById('useMyLocationBtn').addEventListener('click', function() {
            const statusEl = document.getElementById('locationStatus');
            const btn = this;
            
            // Check if geolocation is supported
            if (!navigator.geolocation) {
                statusEl.innerHTML = '<span class="text-red-600">‚ùå Geolocation is not supported by your browser</span>';
                statusEl.classList.remove('hidden');
                return;
            }

            // Show loading status
            statusEl.innerHTML = '<span class="text-blue-600">üì° Getting your location...</span>';
            statusEl.classList.remove('hidden');
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Getting Location...';

            // Helper: compute haversine distance (meters)
            function haversineDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000; // meters
                const toRad = v => v * Math.PI / 180;
                const dLat = toRad(lat2 - lat1);
                const dLon = toRad(lon2 - lon1);
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            // Helper: robust centroid - remove spatial outliers then compute weighted centroid by accuracy
            function computeFilteredCentroid(samples) {
                if (!samples || samples.length === 0) return null;

                // Remove samples with extremely bad accuracy first
                const MAX_ACCEPTABLE_ACC = 3000; // meters - drop anything beyond this
                let filtered = samples.filter(s => s.accuracy && s.accuracy < MAX_ACCEPTABLE_ACC);
                if (filtered.length === 0) filtered = samples.slice();

                // Compute median lat/lon
                const lats = filtered.map(s => s.lat).sort((a,b)=>a-b);
                const lons = filtered.map(s => s.lon).sort((a,b)=>a-b);
                const medianLat = lats[Math.floor(lats.length/2)];
                const medianLon = lons[Math.floor(lons.length/2)];

                // Compute distances from median
                const distances = filtered.map(s => ({...s, dist: haversineDistance(medianLat, medianLon, s.lat, s.lon)}));

                // Compute median distance
                const distVals = distances.map(d => d.dist).sort((a,b)=>a-b);
                const medianDist = distVals.length ? distVals[Math.floor(distVals.length/2)] : 0;

                // Keep samples within max(3*medianDist, 100m)
                const threshold = Math.max(medianDist * 3, 100);
                const inliers = distances.filter(d => d.dist <= threshold);

                // If too few inliers, fall back to best-N by accuracy
                let use = inliers;
                if (use.length < 3) {
                    // take top 5 best accuracy samples
                    use = filtered.slice().sort((a,b)=> (a.accuracy||Infinity) - (b.accuracy||Infinity)).slice(0, Math.min(5, filtered.length));
                }

                // Final weighted centroid using weights inverse to accuracy (plus small epsilon)
                let sumLat=0, sumLon=0, sumW=0;
                use.forEach(s => {
                    const w = 1 / ((s.accuracy || 30) + 1);
                    sumLat += s.lat * w;
                    sumLon += s.lon * w;
                    sumW += w;
                });
                const centroidLat = sumLat / sumW;
                const centroidLon = sumLon / sumW;

                // Estimate accuracy as median of used samples' reported accuracy or medianDist
                const accVals = use.map(u=>u.accuracy||0).sort((a,b)=>a-b);
                const estAcc = accVals.length ? accVals[Math.floor(accVals.length/2)] : medianDist;

                return { lat: centroidLat, lon: centroidLon, accuracy: Math.max(estAcc, medianDist) };
            }

            // Helper: get multiple high-accuracy samples via watchPosition and pick best
            function getBestPosition(options = {}, maxSamples = 15, maxWaitMs = 20000) {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        return reject({ code: 0, message: 'Geolocation not supported' });
                    }

                    let best = null;
                    let samples = 0;
                    const collected = [];
                    const watcher = navigator.geolocation.watchPosition(
                        (pos) => {
                            samples++;
                            const acc = pos.coords.accuracy || Infinity;
                            collected.push({ lat: pos.coords.latitude, lon: pos.coords.longitude, accuracy: acc, timestamp: Date.now() });

                            // Keep smallest accuracy
                            if (!best || acc < (best.coords.accuracy || Infinity)) {
                                best = pos;
                            }

                            // If accuracy is very good and we have multiple samples, stop early
                            if (acc <= 25 && samples >= 3) {
                                navigator.geolocation.clearWatch(watcher);
                                return resolve({ best, samples: collected });
                            }

                            // If we've reached max samples, resolve with collected samples
                            if (samples >= maxSamples) {
                                navigator.geolocation.clearWatch(watcher);
                                return resolve({ best, samples: collected });
                            }
                        },
                        (err) => {
                            try { navigator.geolocation.clearWatch(watcher); } catch(e){}
                            return reject(err);
                        },
                        options
                    );

                    // Fallback timeout: stop watching after maxWaitMs
                    setTimeout(() => {
                        try { navigator.geolocation.clearWatch(watcher); } catch (e) {}
                        if (best) return resolve({ best, samples: collected });
                        return reject({ code: 3, message: 'Timeout obtaining position' });
                    }, maxWaitMs);
                });
            }

            // Try to obtain the most accurate position available (multiple samples)
            getBestPosition({ enableHighAccuracy: true, maximumAge: 0, timeout: 20000 }, 15, 25000)
                .then(({ best, samples }) => {
                    if (!best || !samples || samples.length === 0) throw { code: 2, message: 'No position obtained' };

                    // Compute robust filtered centroid from collected samples
                    const robust = computeFilteredCentroid(samples);
                    const lat = robust ? robust.lat : (best.coords.latitude || best.coords.lat);
                    const lon = robust ? robust.lon : (best.coords.longitude || best.coords.lon);
                    const accuracy = robust ? (robust.accuracy || best.coords.accuracy || 0) : (best.coords.accuracy || 0);

                    // Display samples for debugging in status (first 8)
                    const samplePreview = samples.slice(0, 8).map(s => `(${s.lat.toFixed(6)}, ${s.lon.toFixed(6)}) ¬±${Math.round(s.accuracy)}m`).join('<br>');

                    // Use higher precision for display
                    document.getElementById('latitude').value = lat.toFixed(6);
                    document.getElementById('longitude').value = lon.toFixed(6);

                    generateRandomParams();
                    map.setView([lat, lon], 17);

                    if (marker) { marker.setLatLng([lat, lon]); }
                    else {
                        marker = L.marker([lat, lon], { icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41] }) }).addTo(map);
                    }

                    marker.bindPopup(`<b>üìç Your Location</b><br>Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}<br>Accuracy: ¬±${Math.round(accuracy)}m`).openPopup();

                    if (accuracyCircle) map.removeLayer(accuracyCircle);
                    if (locationRing) map.removeLayer(locationRing);

                    const drawRadius = Math.max(Math.min(accuracy, 5000), 20);
                    accuracyCircle = L.circle([lat, lon], { color:'#3B82F6', fillColor:'#60A5FA', fillOpacity:0.18, weight:2, opacity:0.7, radius: drawRadius }).addTo(map);
                    locationRing = L.circle([lat, lon], { color:'#2563EB', fillColor:'#3B82F6', fillOpacity:0.35, weight:3, opacity:1, radius: Math.min(accuracy/4+10,100) }).addTo(map);

                    // If accuracy is poor, offer to retry with longer sampling
                    const poorThreshold = 150; // meters - lowered to encourage better precision
                    if (accuracy > poorThreshold) {
                        statusEl.innerHTML = `<div class="text-yellow-700">‚ö†Ô∏è Best accuracy obtained: ¬±${Math.round(accuracy)}m ‚Äî this is coarse.<br>${samplePreview}<br><br>
                            <button id="retryLongBtn" class="px-3 py-1 mr-2 rounded bg-blue-600 text-white">Retry longer</button>
                            <button id="acceptBtn" class="px-3 py-1 rounded bg-gray-200">Accept anyway</button>
                        </div>`;

                        // Retry longer handler
                        document.getElementById('retryLongBtn').addEventListener('click', () => {
                            statusEl.innerHTML = '<span class="text-blue-600">‚è≥ Retrying with extended sampling (up to 30s)...</span>';
                            btn.disabled = true;
                            btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Retrying...';

                            getBestPosition({ enableHighAccuracy:true, maximumAge:0, timeout:20000 }, 30, 30000)
                                .then(({ best: best2, samples: samples2 }) => {
                                    if (!best2 || !samples2 || samples2.length === 0) throw { code:2, message:'No position obtained' };
                                    // Compute weighted centroid from extended samples
                                    let sumLat2 = 0, sumLon2 = 0, sumW2 = 0;
                                    samples2.forEach(s => {
                                        const w = 1 / (s.accuracy + 1);
                                        sumLat2 += s.lat * w;
                                        sumLon2 += s.lon * w;
                                        sumW2 += w;
                                    });
                                    const lat2 = sumLat2 / sumW2;
                                    const lon2 = sumLon2 / sumW2;
                                    // Use accuracy of best2 for display
                                    const acc2 = best2.coords.accuracy || 0;
                                    document.getElementById('latitude').value = lat2.toFixed(6);
                                    document.getElementById('longitude').value = lon2.toFixed(6);
                                    marker.setLatLng([lat2, lon2]);
                                    map.setView([lat2, lon2], 17);
                                    if (accuracyCircle) map.removeLayer(accuracyCircle);
                                    if (locationRing) map.removeLayer(locationRing);
                                    accuracyCircle = L.circle([lat2, lon2], { color:'#3B82F6', fillColor:'#60A5FA', fillOpacity:0.18, weight:2, opacity:0.7, radius: Math.max(Math.min(acc2,5000),20) }).addTo(map);
                                    locationRing = L.circle([lat2, lon2], { color:'#2563EB', fillColor:'#3B82F6', fillOpacity:0.35, weight:3, opacity:1, radius: Math.min(acc2/4+10,100) }).addTo(map);
                                    statusEl.innerHTML = `<span class="text-green-600">‚úÖ Improved accuracy: ¬±${Math.round(acc2)}m</span>`;
                                    btn.disabled = false;
                                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Use My Location';
                                    setTimeout(() => { autoLoadNearbyBorewells(lat2, lon2, 'Your Location'); }, 500);
                                })
                                .catch((err) => {
                                    statusEl.innerHTML = `<span class="text-red-600">Retry failed: ${err.message || 'error'}</span>`;
                                    btn.disabled = false;
                                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Use My Location';
                                });
                        });

                        // Accept anyway handler
                        document.getElementById('acceptBtn').addEventListener('click', () => {
                            statusEl.innerHTML = `<span class="text-yellow-700">Accepted coarse position: ¬±${Math.round(accuracy)}m</span>`;
                            btn.disabled = false;
                            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Use My Location';
                            setTimeout(() => { autoLoadNearbyBorewells(lat, lon, 'Your Location'); }, 500);
                        });
                    } else {
                        const radiusKm = (drawRadius / 1000).toFixed(2);
                        statusEl.innerHTML = `<span class="text-green-600">‚úÖ Location found! Accuracy: ¬±${accuracy.toFixed(0)}m<br>üîµ Blue circles show your estimated area (${radiusKm}km radius)</span>`;
                        btn.disabled = false;
                        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Use My Location';
                        setTimeout(() => { autoLoadNearbyBorewells(lat, lon, 'Your Location'); }, 500);
                    }
                })
                .catch((error) => {
                    let errorMsg = '';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = '‚ùå Location access denied. Please enable location permissions.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = '‚ùå Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = '‚ùå Location request timed out.';
                            break;
                        default:
                            errorMsg = error.message || '‚ùå An unknown error occurred.';
                            break;
                    }
                    statusEl.innerHTML = `<span class="text-red-600">${errorMsg}</span>`;
                    btn.disabled = false;
                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Use My Location';
                });
        });

        // ========== AI-POWERED SEARCH WITH GEMINI ==========
        
        // Cache for AI suggestions to reduce API calls
        let aiSuggestionsCache = {};
        let lastSearchQuery = '';
        let searchDebounceTimer = null;
        
        // Recent searches (stored in memory)
        let recentSearches = [];
        
        // Currently selected suggestion index
        let selectedSuggestionIndex = -1;
        let currentSuggestions = [];
        let allSuggestions = [];  // Store all suggestions for consistent access
        
        // Fetch AI-powered suggestions from Gemini
        async function fetchAISuggestions(query, maxResults = 10) {
            // Check cache first
            const cacheKey = `${query}_${maxResults}`;
            if (aiSuggestionsCache[cacheKey]) {
                console.log('ÔøΩ Using cached AI suggestions for:', query);
                return aiSuggestionsCache[cacheKey];
            }
            
            try {
                console.log('ü§ñ Fetching AI suggestions for:', query);
                const response = await fetch('/ai_search_suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, max_results: maxResults })
                });
                
                const result = await response.json();
                
                if (result.success && result.suggestions) {
                    // Cache the results
                    aiSuggestionsCache[cacheKey] = result.suggestions;
                    console.log(`‚úÖ Got ${result.suggestions.length} AI suggestions`);
                    return result.suggestions;
                } else {
                    console.error('‚ùå AI search failed:', result.error);
                    return [];
                }
            } catch (error) {
                console.error('‚ùå Error fetching AI suggestions:', error);
                return [];
            }
        }

        // --- Local places cache (fast client-side autocomplete) ---
        let localPlaces = []; // {name, lat, lon, taluka, district}

        async function loadLocalPlaces() {
            try {
                const resp = await fetch('/local_places');
                const data = await resp.json();
                if (data.success && Array.isArray(data.places)) {
                    localPlaces = data.places.map(p => ({
                        name: p.name,
                        lat: p.lat,
                        lon: p.lon,
                        taluka: p.taluka || '',
                        district: p.district || ''
                    }));
                    console.log('Loaded', localPlaces.length, 'local places for autocomplete');
                }
            } catch (err) {
                console.warn('Failed to load local places:', err);
            }
        }

        // Start loading local places immediately
        loadLocalPlaces();
        
        // Show suggestions dropdown
        function showSuggestions(locations, query = '') {
            const dropdown = document.getElementById('suggestionsDropdown');
            const listEl = document.getElementById('suggestionsList');
            
            if (locations.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            
            // Store suggestions in both variables for consistency
            currentSuggestions = locations;
            allSuggestions = locations;
            selectedSuggestionIndex = -1;
            
            let html = '';
            
            // Show "Recent Searches" header if applicable
            if (!query && recentSearches.length > 0) {
                html += `
                    <div class="px-4 py-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                        <span class="text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">üïê Recent Searches</span>
                    </div>
                `;
                
                recentSearches.slice(0, 3).forEach((loc, idx) => {
                    html += `
                        <div class="suggestion-item px-4 py-3 hover:bg-indigo-100 dark:hover:bg-gray-600 cursor-pointer border-b border-gray-100 dark:border-gray-700 transition-all duration-150 active:bg-indigo-200 dark:active:bg-gray-500" data-index="${idx}">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold text-gray-800 dark:text-gray-100">${loc.name}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${loc.category}</div>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                        </div>
                    `;
                });
                
                if (locations.length > 0) {
                    html += `
                        <div class="px-4 py-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 mt-2">
                            <span class="text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">‚≠ê Popular Locations</span>
                        </div>
                    `;
                }
            }
            
            // Group by category
            const grouped = {};
            locations.forEach(loc => {
                if (!grouped[loc.category]) grouped[loc.category] = [];
                grouped[loc.category].push(loc);
            });
            
            // Display suggestions
            let globalIndex = recentSearches.length > 0 ? recentSearches.slice(0, 3).length : 0;
            Object.keys(grouped).forEach(category => {
                if (!query) {
                    html += `
                        <div class="px-4 py-2 bg-gradient-to-r from-indigo-50 to-blue-50 dark:from-gray-700 dark:to-gray-600 border-b border-indigo-100 dark:border-gray-600">
                            <span class="text-xs font-semibold text-indigo-700 dark:text-indigo-300 uppercase">${category}</span>
                        </div>
                    `;
                }
                
                grouped[category].forEach(loc => {
                    const displayName = query ? highlightMatch(loc.name, query) : loc.name;
                    
                    // Build badges HTML
                    let badgesHtml = '';
                    if (loc.popular) {
                        badgesHtml += '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 dark:bg-amber-900/40 text-amber-800 dark:text-amber-300 mr-1">‚≠ê Popular</span>';
                    }
                    if (loc.trending) {
                        badgesHtml += '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-pink-100 dark:bg-pink-900/40 text-pink-800 dark:text-pink-300 mr-1">üî• Trending</span>';
                    }
                    
                    // Build description HTML
                    const descHtml = loc.description ? `<div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${loc.description}</div>` : '';
                    
                    // Check if this is a Google Places result
                    const isGooglePlace = loc.needsCoordinates && loc.place_id;
                    const googleBadge = isGooglePlace ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-300 mr-1">üó∫Ô∏è Google</span>' : '';
                    
                    html += `
                        <div class="suggestion-item px-4 py-3 hover:bg-gradient-to-r hover:from-indigo-100 hover:to-purple-100 dark:hover:from-gray-600 dark:hover:to-gray-500 cursor-pointer border-b border-gray-100 dark:border-gray-700 transition-all duration-200 active:bg-indigo-200 dark:active:bg-gray-500" data-index="${globalIndex}">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <div class="font-semibold text-gray-800 dark:text-gray-100 text-base">${displayName}</div>
                                        ${googleBadge}
                                        ${badgesHtml}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">${loc.category}</span>
                                    </div>
                                    ${descHtml}
                                </div>
                                <div class="flex flex-col items-end ml-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ${isGooglePlace ? 'text-blue-500 dark:text-blue-400' : 'text-indigo-400 dark:text-indigo-300'}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    <span class="text-xs text-gray-400 dark:text-gray-500 mt-1">Click to select</span>
                                </div>
                            </div>
                        </div>
                    `;
                    globalIndex++;
                });
            });
            
            // Footer with count
            html += `
                <div class="px-4 py-2 bg-gray-50 dark:bg-gray-700 text-center">
                    <span class="text-xs text-gray-500 dark:text-gray-400">${locations.length} location${locations.length !== 1 ? 's' : ''} available</span>
                </div>
            `;
            
            listEl.innerHTML = html;
            dropdown.classList.remove('hidden');
            
            // Add click handlers - Use mousedown for more reliable click detection
            document.querySelectorAll('.suggestion-item').forEach((item, idx) => {
                // Use mousedown instead of click for more reliable event handling
                item.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const dataIndex = parseInt(item.dataset.index);
                    console.log('üñ±Ô∏è Item clicked - data-index:', dataIndex, 'Recent searches:', recentSearches.length, 'Query:', query);
                    
                    let selectedLoc;
                    
                    // Handle recent searches (shown when no query)
                    if (!query && recentSearches.length > 0 && dataIndex < recentSearches.slice(0, 3).length) {
                        selectedLoc = recentSearches[dataIndex];
                        console.log('üìç Selected from recent searches:', selectedLoc);
                    } else {
                        // Calculate adjusted index for main suggestions
                        let adjustedIndex = dataIndex;
                        if (!query && recentSearches.length > 0) {
                            adjustedIndex = dataIndex - recentSearches.slice(0, 3).length;
                        }
                        
                        console.log('üìç Adjusted index for suggestions:', adjustedIndex, 'Total suggestions:', allSuggestions.length);
                        
                        // Use allSuggestions for consistency with Enter key handler
                        if (adjustedIndex >= 0 && adjustedIndex < allSuggestions.length) {
                            selectedLoc = allSuggestions[adjustedIndex];
                            console.log('‚úÖ Selected location:', selectedLoc);
                        } else {
                            console.error('‚ùå Index out of bounds:', adjustedIndex, 'Total:', allSuggestions.length);
                        }
                    }
                    
                    if (selectedLoc) {
                        selectLocation(selectedLoc);
                    } else {
                        console.error('‚ùå No location found for data-index:', dataIndex);
                    }
                });
                
                // Also add click handler as backup
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                });
                
                // Hover effect for keyboard navigation
                item.addEventListener('mouseenter', () => {
                    document.querySelectorAll('.suggestion-item').forEach(el => {
                        el.classList.remove('bg-indigo-100', 'bg-indigo-50');
                    });
                    item.classList.add('bg-indigo-100');
                    selectedSuggestionIndex = parseInt(item.dataset.index);
                });
            });
        }
        
        // Highlight matching text
        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="bg-yellow-200 font-semibold">$1</span>');
        }
        
        // Filter locations based on query (ENHANCED)
        // Enhanced Google Places Autocomplete - Works like Google Maps!
        async function filterLocations(query) {
            if (!query) {
                // Show popular/recent locations when no query
                try {
                    // First try Google Places nearby
                    const nearbyResp = await fetch('/maps_nearby_search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            lat: 19.9975, 
                            lng: 73.7898, 
                            radius: 50000, 
                            max_results: 15 
                        })
                    });
                    const nearbyData = await nearbyResp.json();
                    
                    if (nearbyData.success && nearbyData.places && nearbyData.places.length > 0) {
                        return nearbyData.places.map(p => ({
                            name: p.name || p.description || p.main_text || 'Unknown',
                            category: p.category || p.types?.[0] || 'Place',
                            description: p.address || p.vicinity || p.secondary_text || '',
                            popular: true,
                            lat: p.latitude || p.lat,
                            lon: p.longitude || p.lng,
                            place_id: p.place_id
                        }));
                    }
                } catch (error) {
                    console.warn('Error fetching nearby places:', error);
                }
                return [];
            }
            
            // PRIMARY: Use Google Places Autocomplete (fastest and most accurate!)
            try {
                const autocompleteResp = await fetch('/maps_autocomplete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, max_results: 10 })
                });
                
                const autocompleteData = await autocompleteResp.json();
                console.log('üó∫Ô∏è Google Places Autocomplete:', autocompleteData);
                
                if (autocompleteData.success && autocompleteData.suggestions && autocompleteData.suggestions.length > 0) {
                    // Map Google autocomplete format to our format
                    return autocompleteData.suggestions.map(s => ({
                        name: s.main_text || s.description || s.name,
                        category: s.types?.[0] || 'Place',
                        description: s.secondary_text || s.address || s.description || '',
                        popular: false,
                        lat: null,  // Will be resolved when selected
                        lon: null,
                        place_id: s.place_id,
                        needsCoordinates: true  // Flag to fetch coordinates on selection
                    }));
                }
            } catch (error) {
                console.warn('Google Autocomplete failed:', error);
            }
            
            // FALLBACK 1: Local places database
            try {
                const q = query.toLowerCase();
                const prefixMatches = [];
                const substringMatches = [];
                localPlaces.forEach(p => {
                    const name = (p.name || '').toLowerCase();
                    if (!name) return;
                    if (name.startsWith(q)) prefixMatches.push(p);
                    else if (name.includes(q)) substringMatches.push(p);
                });

                const combined = prefixMatches.concat(substringMatches).slice(0, 8);
                if (combined.length > 0) {
                    return combined.map(p => ({
                        name: p.name,
                        category: p.taluka || p.district || 'Local',
                        description: `${p.taluka || ''} ${p.district || ''}`.trim(),
                        lat: p.lat,
                        lon: p.lon,
                        popular: false
                    }));
                }
            } catch (err) {
                console.warn('Local autocomplete failed:', err);
            }
            
            // FALLBACK 2: AI suggestions
            try {
                const aiSuggestions = await fetchAISuggestions(query, 10);
                if (aiSuggestions && aiSuggestions.length > 0) {
                    return aiSuggestions;
                }
            } catch (err) {
                console.warn('AI suggestions failed:', err);
            }
            
            return [];
        }
        
        // Select a location from suggestions (Enhanced for Google Places)
        async function selectLocation(location) {
            console.log('üéØ Location selected:', location);
            
            // Validate location object
            if (!location || !location.name) {
                console.error('‚ùå Invalid location object:', location);
                return;
            }
            
            const searchInput = document.getElementById('locationSearch');
            const resultsEl = document.getElementById('searchResults');
            const dropdown = document.getElementById('suggestionsDropdown');
            
            searchInput.value = location.name;
            dropdown.classList.add('hidden');

            // Add to recent searches (avoid duplicates)
            recentSearches = recentSearches.filter(loc => loc.name !== location.name);
            recentSearches.unshift(location);
            if (recentSearches.length > 5) recentSearches.pop();

            // Handle Google Places selections that need coordinate resolution
            if (location.needsCoordinates && location.place_id) {
                resultsEl.innerHTML = '<span class="text-blue-600 dark:text-blue-400">üó∫Ô∏è Getting location details from Google Maps...</span>';
                
                try {
                    // Fetch full place details including coordinates
                    const response = await fetch('/maps_place_details', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ place_id: location.place_id })
                    });
                    
                    const data = await response.json();
                    console.log('üìç Google Place Details:', data);
                    
                    if (data.success && data.details) {
                        location.lat = data.details.latitude;
                        location.lon = data.details.longitude;
                        location.description = data.details.address;
                        
                        // Now proceed with coordinates
                        displayLocationOnMap(location, resultsEl);
                    } else {
                        resultsEl.innerHTML = '<span class="text-red-600 dark:text-red-400">‚ùå Could not get coordinates for this location</span>';
                    }
                } catch (error) {
                    console.error('Error fetching place details:', error);
                    resultsEl.innerHTML = '<span class="text-red-600 dark:text-red-400">‚ùå Error loading location details</span>';
                }
                return;
            }

            // If the suggestion contains coordinates, request boundary by coordinates for better accuracy
            if (location.lat !== undefined && location.lon !== undefined && location.lat !== null && location.lon !== null) {
                // Show immediate UI feedback
                resultsEl.innerHTML = '<span class="text-blue-600 dark:text-blue-400">üîç Loading location on map...</span>';
                displayLocationOnMap(location, resultsEl);
            } else {
                // Fallback to text search
                searchLocation();
            }
        }
        
        // Helper function to display location on map
        function displayLocationOnMap(location, resultsEl) {
            fetch('/get_boundary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat: parseFloat(location.lat), lon: parseFloat(location.lon) })
            })
            .then(resp => resp.json())
            .then(result => {
                if (!result || !result.success) {
                    resultsEl.innerHTML = `<span class="text-orange-600 dark:text-orange-400">‚ö†Ô∏è ${result && result.error ? result.error : 'Failed to fetch boundary'}</span>`;
                    // Still center the map on the coordinates
                    map.setView([location.lat, location.lon], 15);
                    if (!marker) marker = L.marker([location.lat, location.lon]).addTo(map);
                    marker.setLatLng([location.lat, location.lon]);
                    marker.bindPopup(`<b>${location.name}</b><br>${location.description || 'Selected Location'}`).openPopup();
                    
                    // Update form fields
                    document.getElementById('latitude').value = location.lat.toFixed(6);
                    document.getElementById('longitude').value = location.lon.toFixed(6);
                    generateRandomParams();
                    
                    // Auto-load nearby borewells
                    setTimeout(() => { autoLoadNearbyBorewells(location.lat, location.lon, location.name); }, 500);
                    return;
                }
                // Use the same result handling as text searches
                handleBoundaryResult(result, location.name || 'Selected Location');
            })
            .catch(err => {
                console.error('Boundary fetch error:', err);
                resultsEl.innerHTML = `<span class="text-red-600 dark:text-red-400">‚ùå Error fetching boundary: ${err.message || err}</span>`;
            });
        }
        
        // Setup search input handlers
        const searchInput = document.getElementById('locationSearch');
        const clearBtn = document.getElementById('clearSearchBtn');
        const dropdown = document.getElementById('suggestionsDropdown');
        
        // Show/hide clear button with debounced dynamic search (autocomplete -> AI -> popular)
        async function getSuggestionsForQuery(query) {
            // Use local places first for instant autocomplete
            try {
                const q = query.toLowerCase();
                const prefixMatches = [];
                const substringMatches = [];
                localPlaces.forEach(p => {
                    const name = (p.name || '').toLowerCase();
                    if (!name) return;
                    if (name.startsWith(q)) prefixMatches.push(p);
                    else if (name.includes(q)) substringMatches.push(p);
                });

                // Prefer prefix matches first, then substring ‚Äî limit to 25
                const combined = prefixMatches.concat(substringMatches).slice(0, 25);
                if (combined.length > 0) {
                    return combined.map(p => ({
                        name: p.name,
                        category: p.taluka || p.district || 'Local',
                        description: `${p.taluka || ''} ${p.district || ''}`.trim(),
                        lat: p.lat,
                        lon: p.lon,
                        popular: false
                    }));
                }
            } catch (err) {
                console.warn('Local autocomplete failed:', err);
            }

            // Try Google Maps autocomplete first (fast and real place names)
            try {
                const resp = await fetch('/maps_autocomplete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, max_results: 15 })
                });

                const data = await resp.json();
                console.log('maps_autocomplete response', data);
                if (data.success && Array.isArray(data.suggestions) && data.suggestions.length > 0) {
                    // Map suggestions to the expected frontend shape
                    const mapped = data.suggestions.map(s => ({
                        // autocomplete returns description/main_text; keep that as display name
                        name: s.name || s.description || s.main_text || s.display_name || query,
                        category: s.type || s.category || s.place_type || '',
                        description: s.address || s.description || s.secondary_text || s.vicinity || '',
                        popular: s.popular || false,
                        place_id: s.place_id || s.placeId || null,
                        // Autocomplete does not provide coordinates ‚Äî will be resolved on selection if needed
                        lat: s.latitude || s.lat || null,
                        lon: s.longitude || s.lng || null
                    })).filter(item => item.name && item.name.length > 0);

                    if (mapped.length > 0) return mapped;
                }
            } catch (err) {
                console.warn('maps_autocomplete failed:', err);
            }

            // Fallback to AI suggestions
            try {
                const ai = await fetchAISuggestions(query, 15);
                if (Array.isArray(ai) && ai.length > 0) return ai;
            } catch (err) {
                console.warn('AI suggestions failed:', err);
            }

            // Stronger fallback: use text search (maps_search_places) which returns coordinates
            try {
                const resp2 = await fetch('/maps_search_places', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, place_type: null, max_results: 20 })
                });
                const data2 = await resp2.json();
                console.log('maps_search_places response', data2);
                if (data2.success && Array.isArray(data2.places) && data2.places.length > 0) {
                    const mapped2 = data2.places.map(p => ({
                        name: p.name,
                        category: p.category || '',
                        description: p.address || p.vicinity || '',
                        popular: false,
                        lat: p.latitude || p.lat || null,
                        lon: p.longitude || p.lng || null
                    }));
                    if (mapped2.length > 0) return mapped2;
                }
            } catch (err) {
                console.warn('maps_search_places fallback failed:', err);
            }

            // Final fallback: popular locations
            try {
                const popular = await filterLocations('');
                return popular;
            } catch (err) {
                console.warn('Fallback popular failed:', err);
                return [];
            }
        }

        searchInput.addEventListener('input', async (e) => {
            const query = e.target.value.trim();

            // Clear previous debounce timer
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }

            if (query.length > 0) {
                clearBtn.classList.remove('hidden');

                // Show loading state
                showSuggestions([{ 
                    name: 'ü§ñ Searching...', 
                    category: '', 
                    description: 'Looking up "' + query + '"' 
                }], query);

                // Debounce dynamic search (300ms delay)
                searchDebounceTimer = setTimeout(async () => {
                    const suggestions = await getSuggestionsForQuery(query);
                    showSuggestions(suggestions, query);
                }, 300);
            } else {
                clearBtn.classList.add('hidden');
                const popular = await filterLocations('');
                showSuggestions(popular);
            }
        });
        
        // Clear button handler
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearBtn.classList.add('hidden');
            dropdown.classList.add('hidden');
            searchInput.focus();
        });
        
        // On focus: fetch dynamic nearby places (falls back to AI/popular list)
        async function fetchNearbyPlacesOnFocus() {
            const queryVal = searchInput.value.trim();
            // If user already typed, just perform normal filtering
            if (queryVal.length > 0) {
                const filtered = await filterLocations(queryVal);
                showSuggestions(filtered, queryVal);
                return;
            }

            // Try to fetch nearby places using current map center for dynamic suggestions
            try {
                const center = map.getCenter();
                const resp = await fetch('/maps_nearby_search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: center.lat, lng: center.lng, radius: 20000, max_results: 50 })
                });

                const data = await resp.json();
                if (data.success && data.places && data.places.length > 0) {
                    // Map Google/nearby place objects to suggestion shape expected by showSuggestions
                    const mapped = data.places.map(p => ({
                        name: p.name || p.title || p.display_name || `${p.latitude || p.lat}, ${p.longitude || p.lng}`,
                        category: p.category || p.type || p.place_type || 'üìç Place',
                        description: p.address || p.vicinity || p.description || '',
                        popular: p.popular || false,
                        lat: p.latitude || p.lat || p.latlng || (p.location && p.location.lat) || null,
                        lon: p.longitude || p.lng || p.lon || (p.location && p.location.lon) || null
                    })).filter(x => x.lat !== null && x.lon !== null);

                    if (mapped.length > 0) {
                        showSuggestions(mapped);
                        return;
                    }
                }
            } catch (err) {
                console.warn('Nearby search failed, falling back to popular AI suggestions:', err);
            }

            // Fallback: show AI / popular suggestions
            const popular = await filterLocations('');
            showSuggestions(popular);
        }

        // Attach focus handler
        searchInput.addEventListener('focus', fetchNearbyPlacesOnFocus);
        
        // Keyboard navigation
        searchInput.addEventListener('keydown', async (e) => {
            const items = document.querySelectorAll('.suggestion-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, items.length - 1);
                updateSelectedSuggestion(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSelectedSuggestion(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                
                const query = searchInput.value.trim();
                
                // If a suggestion is highlighted, trigger its click (uses same logic as mouse click)
                if (selectedSuggestionIndex >= 0 && items[selectedSuggestionIndex]) {
                    console.log('‚å®Ô∏è Enter pressed - triggering click on highlighted item:', selectedSuggestionIndex);
                    items[selectedSuggestionIndex].dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
                    return;
                }
                
                // If no suggestion is selected but there's a query and suggestions, auto-select first
                if (query.length > 0 && items.length > 0 && allSuggestions.length > 0) {
                    console.log('‚å®Ô∏è Enter pressed - auto-selecting first suggestion');
                    // Trigger click on first item (will handle recent searches vs suggestions correctly)
                    items[0].dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
                    return;
                } else if (query.length > 0) {
                    // No suggestions available, try Google Places search directly
                    const resultsEl = document.getElementById('searchResults');
                    resultsEl.innerHTML = '<span class="text-gray-600 dark:text-gray-400">üîç Searching for location...</span>';
                    
                    try {
                        // Try Google Places Autocomplete first
                        const response = await fetch('/maps_autocomplete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query: query, max_results: 1 })
                        });
                        
                        const data = await response.json();
                        if (data.success && data.suggestions && data.suggestions.length > 0) {
                            const place = data.suggestions[0];
                            // Fetch full place details to get coordinates
                            const detailsResp = await fetch('/maps_place_details', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ place_id: place.place_id })
                            });
                            
                            const detailsData = await detailsResp.json();
                            if (detailsData.success && detailsData.details) {
                                const location = {
                                    name: detailsData.details.name || place.description,
                                    lat: detailsData.details.latitude,
                                    lon: detailsData.details.longitude,
                                    category: 'Google Places',
                                    description: detailsData.details.formatted_address || ''
                                };
                                await displayLocationOnMap(location, resultsEl);
                                dropdown.classList.add('hidden');
                                return;
                            }
                        }
                        
                        // If Google Places fails, fall back to boundary search
                        searchLocation();
                    } catch (err) {
                        console.error('Enter key search error:', err);
                        searchLocation(); // Fallback to regular search
                    }
                }
            } else if (e.key === 'Escape') {
                dropdown.classList.add('hidden');
                searchInput.blur();
            }
        });
        
        // Update visual selection
        function updateSelectedSuggestion(items) {
            items.forEach((item, idx) => {
                if (idx === selectedSuggestionIndex) {
                    item.classList.add('bg-indigo-100');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('bg-indigo-100', 'bg-indigo-50');
                }
            });
        }
        
        // Hide dropdown when clicking outside (but not when clicking inside dropdown)
        document.addEventListener('click', (e) => {
            const dropdownEl = document.getElementById('suggestionsDropdown');
            const searchInputEl = document.getElementById('locationSearch');
            
            // Don't hide if clicking inside the dropdown or search input
            if (e.target.closest('#suggestionsDropdown') || e.target === searchInputEl) {
                return;
            }
            
            // Hide dropdown if clicking anywhere else
            if (dropdownEl && !dropdownEl.contains(e.target) && !searchInputEl.contains(e.target)) {
                dropdownEl.classList.add('hidden');
            }
        });
        
        // Location Search Handler
        async function searchLocation() {
            const query = document.getElementById('locationSearch').value.trim();
            const resultsEl = document.getElementById('searchResults');
            
            if (!query) {
                resultsEl.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Please enter a location name</span>';
                return;
            }

            resultsEl.innerHTML = '<span class="text-gray-600">üîç Searching and fetching boundary...</span>';

            try {
                // Fetch boundary from backend
                const response = await fetch('/get_boundary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ location_name: query })
                });

                const result = await response.json();

                if (!result.success) {
                    resultsEl.innerHTML = `<span class="text-orange-600">‚ùå ${result.error}</span>`;
                    return;
                }

                // Delegate drawing/UI to shared handler
                handleBoundaryResult(result, query);

            } catch (error) {
                resultsEl.innerHTML = `<span class="text-red-600">‚ùå Error: ${error.message}</span>`;
            }
        }

        // Search button handler
        document.getElementById('searchBtn').addEventListener('click', searchLocation);

        // Centralized boundary drawing and UI update helper
        function handleBoundaryResult(result, fallbackName) {
            const resultsEl = document.getElementById('searchResults');

            const lat = result && result.center ? result.center.lat : null;
            const lon = result && result.center ? result.center.lon : null;

            // Remove old boundary if exists
            if (boundaryLayer) {
                map.removeLayer(boundaryLayer);
                boundaryLayer = null;
            }

            if (result.boundary) {
                const geojson = result.boundary;
                boundaryLayer = L.geoJSON(geojson, {
                    style: {
                        color: '#F59E0B', /* yellow-500 */
                        weight: 4,
                        opacity: 1,
                        fillColor: '#F59E0B',
                        fillOpacity: 0.25
                    }
                }).addTo(map);

                // Popup and zoom
                boundaryLayer.bindPopup(`<b>üîµ ${result.display_name || fallbackName}</b><br><small>Administrative Boundary</small>`);
                try { map.fitBounds(boundaryLayer.getBounds(), { padding: [50, 50] }); } catch (e) { if (lat && lon) map.setView([lat, lon], 14); }

                resultsEl.innerHTML = `<span class="text-green-600">‚úÖ Found: <b>${result.display_name || fallbackName}</b><br>üîµ Blue boundary displayed on map</span>`;
            } else if (lat !== null && lon !== null) {
                map.setView([lat, lon], 14);
                resultsEl.innerHTML = `<span class="text-yellow-600">‚ö†Ô∏è Found: ${result.display_name || fallbackName}<br>Boundary data not available for this location. Showing center point only.</span>`;
            } else {
                resultsEl.innerHTML = `<span class="text-red-600">‚ùå No location data returned.</span>`;
            }

            // Add or update marker
            if (lat !== null && lon !== null) {
                if (marker) {
                    marker.setLatLng([lat, lon]);
                } else {
                    marker = L.marker([lat, lon], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                }
                marker.bindPopup(`<b>${result.display_name || fallbackName}</b>`).openPopup();

                // Update form fields
                document.getElementById('latitude').value = lat.toFixed(6);
                document.getElementById('longitude').value = lon.toFixed(6);
                generateRandomParams();

                // Auto-load borewells near the location
                setTimeout(() => { autoLoadNearbyBorewells(lat, lon, result.display_name || fallbackName); }, 500);
            }
        }

        // ========== CATEGORY FILTER FUNCTIONALITY ==========
        let selectedCategory = 'all';
        
        // Category button handlers
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                // Update selected category
                selectedCategory = this.dataset.category;
                
                // Update button styles
                document.querySelectorAll('.category-btn').forEach(b => {
                    b.classList.remove('border-purple-500', 'dark:border-purple-400', 'bg-purple-100', 'dark:bg-purple-900/50', 'font-bold');
                    b.classList.add('border-gray-200', 'dark:border-gray-600');
                });
                this.classList.remove('border-gray-200', 'dark:border-gray-600');
                this.classList.add('border-purple-500', 'dark:border-purple-400', 'bg-purple-100', 'dark:bg-purple-900/50', 'font-bold');
                
                // Get current search query
                const query = document.getElementById('locationSearch').value.trim();
                
                // If there's a query, search with category filter
                if (query) {
                    await searchWithCategory(query, selectedCategory);
                } else {
                    // Show popular places in this category
                    await showPopularCategory(selectedCategory);
                }
            });
        });
        
        // Search with category filter
        async function searchWithCategory(query, category) {
            const resultsEl = document.getElementById('searchResults');
            const suggestionsEl = document.getElementById('suggestionsList');
            const dropdown = document.getElementById('suggestionsDropdown');
            
            resultsEl.innerHTML = `<span class="text-blue-600 dark:text-blue-400">üîç Searching ${category === 'all' ? 'all places' : category} matching "${query}"...</span>`;
            
            try {
                // Use Google Maps API for comprehensive search
                const response = await fetch('/maps_search_places', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: query,
                        place_type: category,
                        max_results: 15
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.places.length > 0) {
                    // Show results in dropdown
                    const placesHTML = result.places.map(place => `
                        <div class="suggestion-item px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-none transition-colors" 
                             data-lat="${place.latitude}" 
                             data-lng="${place.longitude}"
                             data-name="${place.name}"
                             data-address="${place.address}">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">${getCategoryIcon(place.category)}</span>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900 dark:text-gray-100">${place.name}</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${place.address || place.vicinity}</div>
                                    ${place.rating ? `
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 px-2 py-0.5 rounded">‚≠ê ${place.rating}</span>
                                            ${place.user_ratings_total ? `<span class="text-xs text-gray-500 dark:text-gray-400">(${place.user_ratings_total} reviews)</span>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    suggestionsEl.innerHTML = `
                        <div class="px-4 py-2 bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 border-b border-purple-200 dark:border-purple-800 flex items-center justify-between">
                            <span class="text-sm font-semibold text-purple-900 dark:text-purple-200">üìç Found ${result.count} places</span>
                            <span class="text-xs text-purple-700 dark:text-purple-300">Powered by Google Maps</span>
                        </div>
                        ${placesHTML}
                    `;
                    
                    dropdown.classList.remove('hidden');
                    resultsEl.innerHTML = `<span class="text-green-600 dark:text-green-400">‚úÖ Found ${result.count} ${category === 'all' ? 'places' : category} - Click one to view on map</span>`;
                    
                    // Add click handlers to place items
                    document.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const lat = parseFloat(this.dataset.lat);
                            const lng = parseFloat(this.dataset.lng);
                            const name = this.dataset.name;
                            const address = this.dataset.address;
                            
                            // Place marker on map
                            if (marker) {
                                marker.setLatLng([lat, lng]);
                            } else {
                                marker = L.marker([lat, lng], {
                                    icon: L.icon({
                                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41],
                                        popupAnchor: [1, -34],
                                        shadowSize: [41, 41]
                                    })
                                }).addTo(map);
                            }
                            
                            marker.bindPopup(`<b>${name}</b><br>${address}`).openPopup();
                            map.setView([lat, lng], 16);
                            
                            // Update form
                            document.getElementById('latitude').value = lat.toFixed(6);
                            document.getElementById('longitude').value = lng.toFixed(6);
                            document.getElementById('locationSearch').value = name;
                            
                            dropdown.classList.add('hidden');
                            resultsEl.innerHTML = `<span class="text-green-600 dark:text-green-400">‚úÖ Selected: <b>${name}</b></span>`;
                        });
                    });
                    
                } else {
                    resultsEl.innerHTML = `<span class="text-orange-600 dark:text-orange-400">‚ùå No ${category === 'all' ? 'places' : category} found for "${query}"</span>`;
                    dropdown.classList.add('hidden');
                }
                
            } catch (error) {
                resultsEl.innerHTML = `<span class="text-red-600 dark:text-red-400">‚ùå Error: ${error.message}</span>`;
                dropdown.classList.add('hidden');
            }
        }
        
        // Show popular places by category
        async function showPopularCategory(category) {
            if (category === 'all') return;
            
            const resultsEl = document.getElementById('searchResults');
            resultsEl.innerHTML = `<span class="text-blue-600 dark:text-blue-400">üèÜ Loading popular ${category}...</span>`;
            
            try {
                const response = await fetch('/maps_popular_category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        category: category,
                        max_results: 15
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.places.length > 0) {
                    const suggestionsEl = document.getElementById('suggestionsList');
                    const dropdown = document.getElementById('suggestionsDropdown');
                    
                    const placesHTML = result.places.map(place => `
                        <div class="suggestion-item px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-none transition-colors" 
                             data-lat="${place.latitude}" 
                             data-lng="${place.longitude}"
                             data-name="${place.name}"
                             data-address="${place.address}">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">${getCategoryIcon(place.category)}</span>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900 dark:text-gray-100">${place.name}</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${place.address || place.vicinity}</div>
                                    ${place.rating ? `
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 px-2 py-0.5 rounded">‚≠ê ${place.rating}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    suggestionsEl.innerHTML = `
                        <div class="px-4 py-2 bg-gradient-to-r from-yellow-100 to-orange-100 dark:from-yellow-900/30 dark:to-orange-900/30 border-b border-yellow-200 dark:border-yellow-800">
                            <span class="text-sm font-semibold text-orange-900 dark:text-orange-200">üèÜ Popular ${category} in Nashik District</span>
                        </div>
                        ${placesHTML}
                    `;
                    
                    dropdown.classList.remove('hidden');
                    resultsEl.innerHTML = `<span class="text-green-600 dark:text-green-400">‚úÖ Showing ${result.count} popular ${category}</span>`;
                    
                    // Add click handlers
                    document.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const lat = parseFloat(this.dataset.lat);
                            const lng = parseFloat(this.dataset.lng);
                            const name = this.dataset.name;
                            const address = this.dataset.address;
                            
                            if (marker) {
                                marker.setLatLng([lat, lng]);
                            } else {
                                marker = L.marker([lat, lng]).addTo(map);
                            }
                            
                            marker.bindPopup(`<b>${name}</b><br>${address}`).openPopup();
                            map.setView([lat, lng], 16);
                            
                            document.getElementById('latitude').value = lat.toFixed(6);
                            document.getElementById('longitude').value = lng.toFixed(6);
                            document.getElementById('locationSearch').value = name;
                            
                            dropdown.classList.add('hidden');
                        });
                    });
                }
                
            } catch (error) {
                resultsEl.innerHTML = `<span class="text-red-600 dark:text-red-400">‚ùå Error loading ${category}</span>`;
            }
        }
        
        // Get category icon
        function getCategoryIcon(category) {
            const icons = {
                'school': 'üéì',
                'bank': 'üè¶',
                'shop': 'üõçÔ∏è',
                'hospital': 'üè•',
                'temple': 'üïâÔ∏è',
                'mosque': 'üïå',
                'church': '‚õ™',
                'restaurant': 'üçΩÔ∏è',
                'hotel': 'üè®',
                'village': 'üèòÔ∏è',
                'city': 'üèôÔ∏è',
                'government': 'üèõÔ∏è',
                'police': 'üëÆ',
                'other': 'üìç'
            };
            return icons[category] || 'üìç';
        }

        // Area Prediction Button Handler
        document.getElementById('predictAreaBtn').addEventListener('click', async function() {
            if (!currentRectangleBounds) {
                alert('Please draw a rectangle on the map first!');
                return;
            }

            // Show status
            const statusEl = document.getElementById('areaPredictionStatus');
            statusEl.textContent = '‚è≥ Analyzing area and predicting groundwater levels...';
            statusEl.classList.remove('hidden');
            
            // Clear old markers
            clearPredictionMarkers();

            const bounds = currentRectangleBounds;
            const payload = {
                north: bounds.getNorth(),
                south: bounds.getSouth(),
                east: bounds.getEast(),
                west: bounds.getWest()
            };

            try {
                const response = await fetch('/predict_area', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    const stats = result.statistics;
                    
                    // Add color-coded markers for each prediction
                    result.predictions.forEach(pred => {
                        let color, iconUrl, iconSize;
                        
                        // Special styling for Top 5
                        if (pred.is_top) {
                            // Top 5 get GOLD stars with numbers
                            iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png';
                            iconSize = [30, 49];  // Larger for top spots
                        } else {
                            // Regular markers by category
                            if (pred.category === 'low') {
                                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
                            } else if (pred.category === 'medium') {
                                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png';
                            } else {
                                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png';
                            }
                            iconSize = [20, 33];
                        }

                        const m = L.marker([pred.lat, pred.lon], {
                            icon: L.icon({
                                iconUrl: iconUrl,
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: iconSize,
                                iconAnchor: [iconSize[0]/2, iconSize[1]],
                                popupAnchor: [1, -iconSize[1]+10],
                                shadowSize: [iconSize[1], iconSize[1]]
                            })
                        }).addTo(map);

                        // Enhanced popup with ranking info
                        let popupContent = '<div style="text-align: center; min-width: 150px;">';
                        if (pred.is_top) {
                            popupContent += `<div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: white; padding: 8px; border-radius: 8px 8px 0 0; margin: -10px -10px 8px -10px;">
                                <strong style="font-size: 18px;">‚≠ê RANK #${pred.rank} ‚≠ê</strong><br>
                                <span style="font-size: 12px;">TOP RECOMMENDED SPOT</span>
                            </div>`;
                        }
                        popupContent += `
                            <strong style="font-size: 16px; color: ${pred.category === 'high' ? '#10B981' : pred.category === 'medium' ? '#F59E0B' : '#EF4444'};">
                                ${pred.category.toUpperCase()}
                            </strong><br>
                            <strong style="font-size: 18px;">Level: ${pred.value}m</strong><br>
                            <hr style="margin: 8px 0;">
                            <small>Lat: ${pred.lat}<br>Lon: ${pred.lon}</small>
                        `;
                        if (pred.is_top) {
                            popupContent += `
                                <br><button onclick="navigator.clipboard.writeText('${pred.lat}, ${pred.lon}')" 
                                    style="background: #3B82F6; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin-top: 4px;">
                                    üìã Copy Location
                                </button>
                            `;
                        }
                        popupContent += '</div>';
                        
                        m.bindPopup(popupContent);

                        // Add numbered label for top 5
                        if (pred.is_top) {
                            const numberIcon = L.divIcon({
                                className: 'number-label',
                                html: `<div style="
                                    background: #FFD700;
                                    color: #000;
                                    font-weight: bold;
                                    border-radius: 50%;
                                    width: 24px;
                                    height: 24px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    border: 2px solid white;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                    font-size: 14px;
                                ">${pred.rank}</div>`,
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            });
                            
                            L.marker([pred.lat, pred.lon], {icon: numberIcon}).addTo(map);
                        }

                        predictionMarkers.push(m);
                    });

                    // Enhanced status display with statistics and Top 5 list
                    statusEl.innerHTML = `
                        <div style="background: #F0FDF4; border: 2px solid #10B981; border-radius: 8px; padding: 12px; margin-top: 8px;">
                            <div style="font-size: 16px; font-weight: bold; color: #065F46; margin-bottom: 8px;">
                                ‚úÖ Analysis Complete: ${stats.total_points} Points Analyzed
                            </div>
                            
                            <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                                <strong>üìä Area Statistics:</strong><br>
                                Average Level: <strong>${stats.avg_level}m</strong> | 
                                Max: <strong>${stats.max_level}m</strong> | 
                                Min: <strong>${stats.min_level}m</strong><br>
                                üü¢ High: ${stats.high_count} | üü† Medium: ${stats.medium_count} | üî¥ Low: ${stats.low_count}
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: white; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                                <strong style="font-size: 16px;">‚≠ê TOP 5 RECOMMENDED DRILLING LOCATIONS ‚≠ê</strong>
                            </div>
                            
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: left;">
                                ${result.top_5.map((spot, idx) => `
                                    <div style="margin: 6px 0; padding: 8px; background: ${idx === 0 ? '#FEF3C7' : '#F9FAFB'}; border-radius: 4px; border-left: 4px solid #FFD700;">
                                        <strong>#${spot.rank}: ${spot.value}m</strong> 
                                        <span style="color: #6B7280; font-size: 13px;">(${spot.lat}, ${spot.lon})</span>
                                        <span style="float: right; background: ${spot.category === 'high' ? '#10B981' : spot.category === 'medium' ? '#F59E0B' : '#EF4444'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                            ${spot.category.toUpperCase()}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <button onclick="downloadTop5Report()" style="background: #3B82F6; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 8px;">
                                    üì• Download Top 5 Report
                                </button>
                                <button onclick="copyTop5ToClipboard()" style="background: #10B981; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                    üìã Copy Top 5 Coordinates
                                </button>
                            </div>
                        </div>
                    `;

                    // Store top 5 data globally for download functions
                    window.top5Data = result.top_5;
                    window.statsData = stats;
                    
                    // Load weather data for the center of the area
                    const centerLat = (bounds.getNorth() + bounds.getSouth()) / 2;
                    const centerLon = (bounds.getEast() + bounds.getWest()) / 2;
                    loadWeatherData(centerLat, centerLon);
                    
                } else {
                    statusEl.textContent = '‚ùå Error: ' + result.error;
                }
            } catch (error) {
                statusEl.textContent = '‚ùå Error: ' + error.message;
            }
        });

        // Function to download Top 5 report as text file
        function downloadTop5Report() {
            if (!window.top5Data) return;
            
            let report = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += '   GROUNDWATER PREDICTION - TOP 5 DRILLING SPOTS\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            report += `Generated: ${new Date().toLocaleString()}\n`;
            report += `Region: Nashik, Maharashtra, India\n\n`;
            
            report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
            report += '                AREA STATISTICS\n';
            report += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
            report += `Total Points Analyzed: ${window.statsData.total_points}\n`;
            report += `Average Groundwater Level: ${window.statsData.avg_level} meters\n`;
            report += `Maximum Level: ${window.statsData.max_level} meters\n`;
            report += `Minimum Level: ${window.statsData.min_level} meters\n`;
            report += `High Potential Spots: ${window.statsData.high_count}\n`;
            report += `Medium Potential Spots: ${window.statsData.medium_count}\n`;
            report += `Low Potential Spots: ${window.statsData.low_count}\n\n`;
            
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += '           TOP 5 RECOMMENDED LOCATIONS\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            
            window.top5Data.forEach(spot => {
                report += `‚îå‚îÄ RANK #${spot.rank} ${spot.rank === 1 ? '‚≠ê BEST SPOT ‚≠ê' : '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ'}\n`;
                report += `‚îÇ Groundwater Level: ${spot.value} meters (${spot.category.toUpperCase()})\n`;
                report += `‚îÇ Latitude: ${spot.lat}\n`;
                report += `‚îÇ Longitude: ${spot.lon}\n`;
                report += `‚îÇ Google Maps: https://www.google.com/maps?q=${spot.lat},${spot.lon}\n`;
                report += `‚îî${'‚îÄ'.repeat(50)}\n\n`;
            });
            
            report += '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += '                  RECOMMENDATIONS\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            report += '1. Start drilling at Rank #1 location for best results\n';
            report += '2. Verify soil conditions before drilling\n';
            report += '3. Consult local borewell experts for depth estimation\n';
            report += '4. Consider monsoon season for optimal water levels\n';
            report += '5. Ensure proper permits from local authorities\n\n';
            
            report += 'Generated by: Groundwater Prediction System\n';
            report += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            
            // Download
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Top5_Borewell_Locations_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Function to copy Top 5 coordinates to clipboard
        function copyTop5ToClipboard() {
            if (!window.top5Data) return;
            
            let text = 'TOP 5 BOREWELL DRILLING LOCATIONS:\n\n';
            window.top5Data.forEach(spot => {
                text += `#${spot.rank}: ${spot.value}m | ${spot.lat}, ${spot.lon}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Top 5 coordinates copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Function to auto-load borewells within 20km radius for specific location
        async function autoLoadNearbyBorewells(lat, lon, locationName = 'this area') {
            console.log('üèóÔ∏è Auto-loading borewells for:', locationName, lat, lon);
            // Clear existing borewells first
            if (borewellsVisible) {
                borewellMarkers.forEach(m => map.removeLayer(m));
                borewellMarkers = [];
            }
            
            const statusEl = document.getElementById('borewellStatus');
            statusEl.innerHTML = `<span class="text-purple-600">‚è≥ Auto-loading borewells near ${locationName}...</span>`;
            statusEl.classList.remove('hidden');
            
            try {
                const response = await fetch('/get_borewells', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lat: lat,
                        lon: lon,
                        radius: 20  // 20km radius for auto-load
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.borewells.length > 0) {
                    const stats = result.statistics;
                    
                    // Display each borewell on map
                    result.borewells.forEach(bw => {
                        let iconUrl, iconColor;
                        
                        // Different colors for successful/failed borewells
                        if (bw.status === 'Success') {
                            iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png';
                            iconColor = '#9333EA'; // Purple
                        } else {
                            iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png';
                            iconColor = '#6B7280'; // Gray
                        }
                        
                        const bwMarker = L.marker([bw.lat, bw.lon], {
                            icon: L.icon({
                                iconUrl: iconUrl,
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).addTo(map);
                        
                        // Enhanced popup with full borewell details
                        let popupContent = `
                            <div style="min-width: 200px;">
                                <div style="background: ${bw.status === 'Success' ? 'linear-gradient(135deg, #9333EA 0%, #7C3AED 100%)' : '#6B7280'}; 
                                            color: white; padding: 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0;">
                                    <strong style="font-size: 16px;">üèóÔ∏è ${bw.id}</strong><br>
                                    <span style="font-size: 12px;">${bw.location}</span>
                                </div>
                                
                                <table style="width: 100%; font-size: 13px;">
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Status:</td>
                                        <td style="padding: 4px;">
                                            <span style="background: ${bw.status === 'Success' ? '#10B981' : '#EF4444'}; 
                                                         color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                                ${bw.status}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Depth:</td>
                                        <td style="padding: 4px;">${bw.depth}m</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Yield:</td>
                                        <td style="padding: 4px;">${bw.yield} LPH</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Year:</td>
                                        <td style="padding: 4px;">${bw.year}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Quality:</td>
                                        <td style="padding: 4px;">${bw.quality}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Taluka:</td>
                                        <td style="padding: 4px;">${bw.taluka}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; font-weight: bold;">Distance:</td>
                                        <td style="padding: 4px;">${bw.distance} km</td>
                                    </tr>
                                </table>
                                
                                <div style="margin-top: 10px; font-size: 11px; color: #6B7280;">
                                    üìç ${bw.lat.toFixed(4)}, ${bw.lon.toFixed(4)}
                                </div>
                            </div>
                        `;
                        
                        bwMarker.bindPopup(popupContent);
                        borewellMarkers.push(bwMarker);
                    });
                    
                    // Display statistics
                    statusEl.innerHTML = `
                        <div style="background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%); border: 2px solid #9333EA; border-radius: 8px; padding: 12px; margin-top: 8px; box-shadow: 0 2px 8px rgba(147, 51, 234, 0.15);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <strong style="color: #7C3AED; font-size: 15px;">üèóÔ∏è CGWB Borewells Near ${locationName}</strong>
                                <span style="background: #10B981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">AUTO-LOADED</span>
                            </div>
                            <div style="margin-top: 8px; font-size: 13px; color: #4C1D95;">
                                <strong>Found ${stats.total} borewells within ${result.radius_km}km radius</strong><br>
                                ‚úÖ Successful: <strong style="color: #10B981;">${stats.successful}</strong> | 
                                ‚ùå Failed: <strong style="color: #EF4444;">${stats.failed}</strong> | 
                                Success Rate: <strong>${stats.success_rate}%</strong><br>
                                üìä Avg Depth: <strong>${stats.avg_depth}m</strong> | 
                                Avg Yield: <strong>${stats.avg_yield} LPH</strong><br>
                                üìè Depth Range: ${stats.min_depth}m - ${stats.max_depth}m
                            </div>
                        </div>
                    `;
                    
                    borewellsVisible = true;
                    document.getElementById('showBorewellsBtn').classList.add('hidden');
                    document.getElementById('hideBorewellsBtn').classList.remove('hidden');
                    
                    return true;
                } else {
                    statusEl.innerHTML = `<span class="text-yellow-600">‚ö†Ô∏è No borewells found within 20km of ${locationName}</span>`;
                    return false;
                }
                
            } catch (error) {
                statusEl.innerHTML = `<span class="text-red-600">‚ùå Error loading borewells: ${error.message}</span>`;
                return false;
            }
        }
        
        // Function to fetch and display borewells (manual button click - 50km radius)
        async function loadBorewells() {
            const statusEl = document.getElementById('borewellStatus');
            const center = map.getCenter();
            
            statusEl.innerHTML = '<span class="text-purple-600">‚è≥ Loading existing borewells...</span>';
            statusEl.classList.remove('hidden');
            
            try {
                const response = await fetch('/get_borewells', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lat: center.lat,
                        lon: center.lng,
                        radius: 50  // 50km radius for manual search
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.borewells.length > 0) {
                    const stats = result.statistics;
                    
                    // Display each borewell on map
                    result.borewells.forEach(bw => {
                        let iconUrl, iconColor;
                        
                        // Different colors for successful/failed borewells
                        if (bw.status === 'Success') {
                            iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png';
                            iconColor = '#9333EA'; // Purple
                        } else {
                            iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png';
                            iconColor = '#6B7280'; // Gray
                        }
                        
                        const bwMarker = L.marker([bw.lat, bw.lon], {
                            icon: L.icon({
                                iconUrl: iconUrl,
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).addTo(map);
                        
                        // Enhanced popup with full borewell details
                        let popupContent = `
                            <div style="min-width: 200px;">
                                <div style="background: ${bw.status === 'Success' ? 'linear-gradient(135deg, #9333EA 0%, #7C3AED 100%)' : '#6B7280'}; 
                                            color: white; padding: 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0;">
                                    <strong style="font-size: 16px;">üèóÔ∏è ${bw.id}</strong><br>
                                    <span style="font-size: 12px;">${bw.location}</span>
                                </div>
                                
                                <table style="width: 100%; font-size: 13px;">
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Status:</td>
                                        <td style="padding: 4px;">
                                            <span style="background: ${bw.status === 'Success' ? '#10B981' : '#EF4444'}; 
                                                         color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                                ${bw.status}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Depth:</td>
                                        <td style="padding: 4px;">${bw.depth}m</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Yield:</td>
                                        <td style="padding: 4px;">${bw.yield} LPH</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Year:</td>
                                        <td style="padding: 4px;">${bw.year}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Quality:</td>
                                        <td style="padding: 4px;">${bw.quality}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Taluka:</td>
                                        <td style="padding: 4px;">${bw.taluka}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; font-weight: bold;">Distance:</td>
                                        <td style="padding: 4px;">${bw.distance} km</td>
                                    </tr>
                                </table>
                                
                                <div style="margin-top: 10px; font-size: 11px; color: #6B7280;">
                                    üìç ${bw.lat.toFixed(4)}, ${bw.lon.toFixed(4)}
                                </div>
                            </div>
                        `;
                        
                        bwMarker.bindPopup(popupContent);
                        borewellMarkers.push(bwMarker);
                    });
                    
                    // Display statistics
                    statusEl.innerHTML = `
                        <div style="background: #F5F3FF; border: 2px solid #9333EA; border-radius: 8px; padding: 12px; margin-top: 8px;">
                            <strong style="color: #7C3AED; font-size: 15px;">üèóÔ∏è CGWB Borewell Database</strong><br>
                            <div style="margin-top: 8px; font-size: 13px;">
                                <strong>Found ${stats.total} borewells within ${result.radius_km}km</strong><br>
                                ‚úÖ Successful: <strong style="color: #10B981;">${stats.successful}</strong> | 
                                ‚ùå Failed: <strong style="color: #EF4444;">${stats.failed}</strong> | 
                                Success Rate: <strong>${stats.success_rate}%</strong><br>
                                üìä Avg Depth: <strong>${stats.avg_depth}m</strong> | 
                                Avg Yield: <strong>${stats.avg_yield} LPH</strong><br>
                                üìè Depth Range: ${stats.min_depth}m - ${stats.max_depth}m
                            </div>
                        </div>
                    `;
                    
                    borewellsVisible = true;
                    document.getElementById('showBorewellsBtn').classList.add('hidden');
                    document.getElementById('hideBorewellsBtn').classList.remove('hidden');
                    
                } else {
                    statusEl.innerHTML = '<span class="text-yellow-600">‚ö†Ô∏è No borewells found in this area</span>';
                }
                
            } catch (error) {
                statusEl.innerHTML = `<span class="text-red-600">‚ùå Error loading borewells: ${error.message}</span>`;
            }
        }

        // Function to hide borewells
        function hideBorewells() {
            borewellMarkers.forEach(m => map.removeLayer(m));
            borewellMarkers = [];
            borewellsVisible = false;
            
            document.getElementById('borewellStatus').classList.add('hidden');
            document.getElementById('showBorewellsBtn').classList.remove('hidden');
            document.getElementById('hideBorewellsBtn').classList.add('hidden');
        }

        // Show Borewells Button Handler
        document.getElementById('showBorewellsBtn').addEventListener('click', loadBorewells);

        // Hide Borewells Button Handler
        document.getElementById('hideBorewellsBtn').addEventListener('click', hideBorewells);

        // Weather Data Functions
        async function loadWeatherData(lat, lon) {
            console.log('üå¶Ô∏è Loading weather data for:', lat, lon);
            try {
                const response = await fetch('/get_weather_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: lat, lon: lon })
                });

                const result = await response.json();
                console.log('‚úÖ Weather response:', result);

                if (result.success) {
                    const weather = result.current_weather;
                    const stations = result.nearest_stations;
                    
                    // Show weather panel
                    document.getElementById('weatherPanel').classList.remove('hidden');
                    
                    // Update current weather
                    document.getElementById('weatherRainfall').textContent = weather.rainfall.toFixed(1);
                    document.getElementById('weatherTemp').textContent = weather.temperature.toFixed(1);
                    document.getElementById('weatherRiver').textContent = weather.river_water_level.toFixed(2);
                    document.getElementById('weatherSeason').textContent = weather.season.toUpperCase() + ' (' + weather.month_name + ')';
                    document.getElementById('weatherTimestamp').textContent = weather.timestamp;
                    
                    // Show nearest stations
                    if (stations && stations.length > 0) {
                        const stationsPanel = document.getElementById('nearestStations');
                        const stationsList = document.getElementById('stationsList');
                        
                        stationsList.innerHTML = stations.map(station => `
                            <div class="flex justify-between items-center py-1">
                                <span><strong>${station.name}</strong></span>
                                <span class="text-xs text-gray-500">${station.distance_km} km</span>
                            </div>
                            <div class="text-xs text-gray-500 mb-2">${station.type}</div>
                        `).join('');
                        
                        stationsPanel.classList.remove('hidden');
                    }
                } else {
                    console.error('Failed to load weather data:', result.error);
                }
            } catch (error) {
                console.error('Error loading weather data:', error);
            }
        }

        // Recommendation functions removed - Feature disabled
    </script>
</body>
</html>