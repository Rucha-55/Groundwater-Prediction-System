<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Groundwater Level Prediction - Nashik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Draw Plugin -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        /* Enhanced Map Styling */
        #map { 
            height: 500px !important; 
            width: 100% !important;
            border-radius: 1rem; 
            border: 2px solid #e5e7eb;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 1;
            position: relative;
        }
        
        #map:hover {
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }
        
        /* Ensure Leaflet map fills container */
        .leaflet-container {
            height: 100% !important;
            width: 100% !important;
            z-index: 1;
        }
        
        /* Search dropdown z-index */
        #suggestionsDropdown {
            z-index: 9999 !important;
            position: absolute;
        }
        
        /* Ensure search section doesn't overlap */
        #search {
            position: relative;
            z-index: 100;
            margin-bottom: 3rem;
        }
        
        /* Map section positioning */
        #mapSection {
            position: relative;
            z-index: 1;
            margin-top: 2rem;
        }
        
        /* Smooth Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        
        .animate-slideInRight {
            animation: slideInRight 0.5s ease-out forwards;
        }
        
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* Glass morphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        /* Gradient backgrounds */
        .gradient-water {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-nature {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .gradient-ocean {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        /* Button hover effects */
        .btn-hover {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-hover:hover::before {
            left: 100%;
        }
        
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        }
        
        /* Card hover effects */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #764ba2 0%, #667eea 100%);
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        /* ========================================
           MOBILE RESPONSIVE STYLES
           ======================================== */
        
        /* Tablets and small laptops (768px - 1024px) */
        @media (max-width: 1024px) {
            .max-w-7xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }
        
        /* Mobile devices (max 768px) */
        @media (max-width: 768px) {
            /* Map adjustments */
            #map {
                height: 300px !important;
                border-radius: 0.75rem;
            }
            
            /* Hero section */
            h1 {
                font-size: 2rem !important;
                line-height: 1.2;
            }
            
            .text-lg {
                font-size: 1rem !important;
            }
            
            /* Navigation */
            nav {
                padding: 0.5rem 1rem;
            }
            
            /* Cards and sections */
            .rounded-3xl {
                border-radius: 1.5rem !important;
            }
            
            .p-10 {
                padding: 1.5rem !important;
            }
            
            .p-8 {
                padding: 1.25rem !important;
            }
            
            .p-6 {
                padding: 1rem !important;
            }
            
            /* Buttons */
            button, .btn-hover {
                font-size: 0.875rem;
                padding: 0.625rem 1rem;
            }
            
            /* Modal adjustments */
            #ragChatbotModal > div {
                max-width: 95% !important;
                max-height: 95vh !important;
                margin: 0.5rem;
            }
            
            /* Form inputs */
            input[type="text"],
            input[type="number"],
            select {
                font-size: 16px !important; /* Prevents zoom on iOS */
                padding: 0.75rem;
            }
            
            /* Prediction form grid */
            .grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Category buttons */
            .category-btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
            
            /* Stats badges */
            .inline-flex {
                font-size: 0.75rem;
                padding: 0.375rem 0.75rem;
            }
            
            /* Popup content */
            .leaflet-popup-content {
                font-size: 0.875rem !important;
                max-width: 250px !important;
            }
            
            /* Chat messages */
            #chatMessages {
                max-height: 50vh !important;
            }
        }
        
        /* Small mobile devices (max 480px) */
        @media (max-width: 480px) {
            /* Extra compact map */
            #map {
                height: 250px !important;
            }
            
            /* Hero text */
            h1 {
                font-size: 1.5rem !important;
            }
            
            .text-4xl, .text-5xl, .text-6xl {
                font-size: 1.75rem !important;
            }
            
            .text-2xl {
                font-size: 1.25rem !important;
            }
            
            .text-xl {
                font-size: 1rem !important;
            }
            
            /* Compact padding */
            .p-10, .p-8, .p-6 {
                padding: 1rem !important;
            }
            
            .px-8, .px-6 {
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }
            
            /* Buttons stack vertically */
            .flex-row {
                flex-direction: column !important;
            }
            
            .gap-4, .gap-3 {
                gap: 0.5rem !important;
            }
            
            /* Category filters wrap better */
            .flex-wrap {
                gap: 0.375rem !important;
            }
            
            .category-btn {
                font-size: 0.7rem;
                padding: 0.375rem 0.625rem;
            }
            
            /* Modal full screen on tiny devices */
            #ragChatbotModal > div {
                max-width: 100% !important;
                max-height: 100vh !important;
                margin: 0;
                border-radius: 0 !important;
            }
            
            /* Input fields prevent zoom */
            input, select, textarea {
                font-size: 16px !important;
            }
            
            /* Compact stat cards */
            .inline-flex {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
        }
        
        /* Landscape orientation fix */
        @media (max-height: 600px) and (orientation: landscape) {
            #map {
                height: 200px !important;
            }
            
            #ragChatbotModal > div {
                max-height: 95vh !important;
                overflow-y: auto;
            }
            
            #chatMessages {
                max-height: 30vh !important;
            }
        }
        
        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            /* iOS Safari */
            input, select, textarea {
                font-size: 16px !important; /* Prevent zoom */
            }
            
            /* Fix for iOS bottom navigation */
            body {
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            /* Modal positioning for iOS */
            #ragChatbotModal {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* Android Chrome specific */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            select {
                background-image: none; /* Remove custom arrow on Android */
            }
        }
        
        /* Touch-friendly sizing */
        @media (hover: none) and (pointer: coarse) {
            /* Increase touch targets on mobile */
            button, a, input[type="submit"], input[type="button"] {
                min-height: 44px; /* Apple HIG recommendation */
                min-width: 44px;
            }
            
            /* Larger checkboxes/radio on touch */
            input[type="checkbox"], input[type="radio"] {
                width: 20px;
                height: 20px;
            }
        }
        
        /* Smooth page transitions */
        .page-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease, transform 0.6s ease;
        }
        
        .page-section.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* ========================================
           GOOGLE TRANSLATE CUSTOM STYLING
           ======================================== */
        
        /* Hide Google Translate banner */
        .goog-te-banner-frame {
            display: none !important;
        }
        
        body {
            top: 0 !important;
        }
        
        /* Style the translate dropdown */
        #google_translate_element select,
        #google_translate_element_mobile select {
            background-color: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23374151'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25rem;
        }
        
        #google_translate_element select:hover,
        #google_translate_element_mobile select:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        #google_translate_element select:focus,
        #google_translate_element_mobile select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        /* Dark mode for translate */
        .dark #google_translate_element select,
        .dark #google_translate_element_mobile select {
            background-color: #1f2937;
            border-color: #374151;
            color: #e5e7eb;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23e5e7eb'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        }
        
        .dark #google_translate_element select:hover,
        .dark #google_translate_element_mobile select:hover {
            border-color: #60a5fa;
            background-color: #374151;
        }
        
        /* Hide Google Translate branding */
        .goog-logo-link {
            display: none !important;
        }
        
        .goog-te-gadget {
            color: transparent !important;
            font-size: 0 !important;
        }
        
        .goog-te-gadget span {
            display: none !important;
        }
        
        /* Mobile responsive translate */
        @media (max-width: 768px) {
            #google_translate_element select,
            #google_translate_element_mobile select {
                width: 100%;
                font-size: 0.875rem;
                padding: 0.625rem 2rem 0.625rem 0.75rem;
            }
        }
        
        /* Add language icon before dropdown */
        #google_translate_element::before,
        #google_translate_element_mobile::before {
            content: "🌐";
            font-size: 1.25rem;
            margin-right: 0.5rem;
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Pulse animation for language selector on page load */
        @keyframes languagePulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(59, 130, 246, 0);
            }
        }
        
        /* Apply pulse for first 5 seconds after page load */
        .language-selector-pulse {
            animation: languagePulse 2s ease-in-out 3;
        }
        
        /* Make select dropdown more visible */
        #google_translate_element select,
        #google_translate_element_mobile select {
            min-width: 150px;
        }
    </style>
    
    <!-- Google Translate Script -->
    <script type="text/javascript">
        function googleTranslateElementInit() {
            // Desktop translate widget
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,hi,mr,gu,ta,te,kn,ml,bn,pa,ur,ar,zh-CN,zh-TW,ja,ko,es,fr,de,it,pt,ru,nl,pl,tr,vi,th,id,ms',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
            
            // Mobile translate widget
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,hi,mr,gu,ta,te,kn,ml,bn,pa,ur,ar,zh-CN,zh-TW,ja,ko,es,fr,de,it,pt,ru,nl,pl,tr,vi,th,id,ms',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element_mobile');
        }
    </script>
    <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    
    <script>
        // Tailwind config for custom colors and dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                        accent: '#4facfe',
                        water: '#00f2fe',
                        nature: '#10b981',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-cyan-50 to-teal-50 dark:from-gray-900 dark:via-slate-900 dark:to-gray-800 min-h-screen transition-colors duration-300">
    <!-- Professional Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 z-50 glass backdrop-blur-lg border-b border-white/20 dark:bg-gray-900/90 dark:border-gray-700/50 transition-colors">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center space-x-3 animate-fadeInUp">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 dark:from-blue-400 dark:to-cyan-400 bg-clip-text text-transparent">
                            Groundwater AI
                        </h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Nashik District</p>
                    </div>
                </div>
                
                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-6">
                    <a href="#search" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Search</a>
                    <a href="#map" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Map</a>
                    <a href="#predictions" class="text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Predictions</a>
                    
                    <!-- Language Selector with Icon -->
                    <div class="flex items-center gap-2 px-3 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                        </svg>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Language:</span>
                        <div id="google_translate_element" class="inline-block"></div>
                    </div>
                    
                    <button id="darkModeToggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </button>
                </div>
                
                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="md:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700 dark:text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden md:hidden border-t border-white/20 dark:border-gray-700">
            <div class="px-4 py-4 space-y-3 bg-white/50 dark:bg-gray-900/90 backdrop-blur-lg">
                <a href="#search" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Search</a>
                <a href="#map" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Map</a>
                <a href="#predictions" class="block py-2 text-gray-700 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors font-medium">Predictions</a>
                
                <!-- Language Selector for Mobile -->
                <div class="py-3 px-3 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <div class="flex items-center gap-2 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                        </svg>
                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">Select Language / भाषा चुनें</span>
                    </div>
                    <div id="google_translate_element_mobile"></div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content Container -->
    <div class="pt-24 pb-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Hero Header -->
            <div class="text-center mb-12 animate-fadeInUp">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold mb-4">
                    <span class="bg-gradient-to-r from-blue-600 via-cyan-500 to-teal-500 dark:from-blue-400 dark:via-cyan-400 dark:to-teal-400 bg-clip-text text-transparent">
                        Groundwater Level Prediction
                    </span>
                </h1>
                <p class="text-lg sm:text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
                    AI-powered groundwater analysis for Nashik District using real-time data and machine learning
                </p>
                <div class="mt-6 flex flex-wrap justify-center gap-4">
                    <div class="inline-flex items-center px-4 py-2 bg-green-100 dark:bg-green-900/30 rounded-full">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse-slow mr-2"></span>
                        <span class="text-sm font-medium text-green-700 dark:text-green-400">Live Weather Data</span>
                    </div>
                    <div class="inline-flex items-center px-4 py-2 bg-purple-100 dark:bg-purple-900/30 rounded-full">
                        <span class="w-2 h-2 bg-purple-500 rounded-full animate-pulse-slow mr-2"></span>
                        <span class="text-sm font-medium text-purple-700 dark:text-purple-400">AI Recommendations</span>
                    </div>
                    <div class="inline-flex items-center px-4 py-2 bg-blue-100 dark:bg-blue-900/30 rounded-full">
                        <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse-slow mr-2"></span>
                        <span class="text-sm font-medium text-blue-700 dark:text-blue-400">30+ Borewells</span>
                    </div>
                </div>
            </div>
            
            <!-- Main Card -->
            <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl overflow-hidden animate-fadeInUp transition-colors" style="animation-delay: 0.2s;">
                <div class="p-6 sm:p-8 lg:p-10">
                
                    <!-- Enhanced Search Box with Autocomplete -->
                    <div id="search" class="mb-8 relative page-section">
            <div class="flex items-center mb-4">
                <div class="p-3 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl shadow-lg mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Search Location</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Find groundwater data for Nashik District</p>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3">
                <div class="flex-1 relative group">
                    <input 
                        type="text" 
                        id="locationSearch" 
                        placeholder="Try: Nashik, Malegaon, Sinnar, K.K.Wagh..." 
                        autocomplete="off"
                        class="w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-lg text-base py-4 pl-14 pr-12 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all duration-300 hover:shadow-xl">
                    <!-- Search icon -->
                    <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 group-focus-within:text-blue-500 dark:group-focus-within:text-blue-400 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <!-- Clear button -->
                    <button type="button" id="clearSearchBtn" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 transition-all hover:scale-110 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    
                    <!-- Autocomplete Suggestions Dropdown -->
                    <div id="suggestionsDropdown" class="absolute w-full mt-2 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 hidden max-h-96 overflow-y-auto transition-colors" style="z-index: 9999;">
                        <div id="suggestionsList"></div>
                    </div>
                </div>
                <button type="button" id="searchBtn" class="bg-gradient-to-r from-blue-600 to-cyan-600 dark:from-blue-500 dark:to-cyan-500 text-white py-4 px-8 rounded-xl hover:from-blue-700 hover:to-cyan-700 dark:hover:from-blue-600 dark:hover:to-cyan-600 transition-all duration-300 font-semibold shadow-lg hover:shadow-xl btn-hover flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <span class="hidden sm:inline">Search</span>
                </button>
            </div>
            
            <!-- Place Category Filters -->
            <div class="mt-4 p-4 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl border border-purple-100 dark:border-purple-800">
                <div class="flex items-center gap-2 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-600 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    <span class="font-semibold text-gray-800 dark:text-gray-100">Search by Category:</span>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-purple-500 dark:hover:border-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/30 transition-all duration-200 text-sm font-medium" data-category="all">
                        🌍 All Places
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-all duration-200 text-sm font-medium" data-category="city">
                        🏙️ Cities/Towns
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-green-500 dark:hover:border-green-400 hover:bg-green-50 dark:hover:bg-green-900/30 transition-all duration-200 text-sm font-medium" data-category="village">
                        🏘️ Villages
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-yellow-500 dark:hover:border-yellow-400 hover:bg-yellow-50 dark:hover:bg-yellow-900/30 transition-all duration-200 text-sm font-medium" data-category="school">
                        🎓 Schools
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-indigo-500 dark:hover:border-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-all duration-200 text-sm font-medium" data-category="bank">
                        🏦 Banks
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-pink-500 dark:hover:border-pink-400 hover:bg-pink-50 dark:hover:bg-pink-900/30 transition-all duration-200 text-sm font-medium" data-category="shop">
                        🛍️ Shops
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-red-500 dark:hover:border-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 transition-all duration-200 text-sm font-medium" data-category="hospital">
                        🏥 Hospitals
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-orange-500 dark:hover:border-orange-400 hover:bg-orange-50 dark:hover:bg-orange-900/30 transition-all duration-200 text-sm font-medium" data-category="temple">
                        🕉️ Temples
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-teal-500 dark:hover:border-teal-400 hover:bg-teal-50 dark:hover:bg-teal-900/30 transition-all duration-200 text-sm font-medium" data-category="restaurant">
                        🍽️ Restaurants
                    </button>
                    <button class="category-btn px-4 py-2 bg-white dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hover:border-cyan-500 dark:hover:border-cyan-400 hover:bg-cyan-50 dark:hover:bg-cyan-900/30 transition-all duration-200 text-sm font-medium" data-category="hotel">
                        🏨 Hotels
                    </button>
                </div>
            </div>
            
            <div id="searchResults" class="mt-3 text-sm"></div>
            
            <!-- Quick Tips -->
            <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl border border-blue-100 dark:border-blue-800">
                <div class="flex flex-wrap gap-4 text-xs text-gray-600 dark:text-gray-300">
                    <span class="flex items-center gap-2">
                        <span class="p-1.5 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </span>
                        <span>Click search box to see 50+ locations</span>
                    </span>
                    <span class="flex items-center gap-2">
                        <span class="p-1.5 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" />
                            </svg>
                        </span>
                        <span>Use ↑↓ arrows to navigate suggestions</span>
                    </span>
                </div>
            </div>
                    </div>

                    <!-- Spacer -->
                    <div class="h-8"></div>

                    <!-- Map Section -->
                    <div id="mapSection" class="mb-8 page-section">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-4">
                <div class="flex items-center">
                    <div class="p-3 bg-gradient-to-br from-green-500 to-teal-500 rounded-xl shadow-lg mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Interactive Map</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Click or draw area to select location</p>
                    </div>
                </div>
                <button type="button" id="useMyLocationBtn" class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-3 px-5 rounded-xl hover:from-blue-700 hover:to-cyan-700 transition-all duration-300 font-semibold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl btn-hover">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Use My GPS Location
                </button>
            </div>
            
            <div class="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 rounded-xl border border-blue-100 dark:border-blue-800 mb-4">
                <p class="text-sm text-gray-700 dark:text-gray-200 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span><strong>Tip:</strong> Click anywhere on map OR use the rectangle tool (□) to draw a selection area</span>
                </p>
            </div>
            
            <div id="locationStatus" class="mb-3 text-sm font-medium hidden"></div>
            
            <!-- Borewell Toggle Buttons -->
            <div class="mb-4 flex flex-wrap gap-3">
                <button type="button" id="showBorewellsBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 px-5 rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all duration-300 font-semibold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl btn-hover">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    Show 30+ Existing Borewells
                </button>
                <button type="button" id="hideBorewellsBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 px-5 rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all duration-300 font-semibold text-sm flex items-center gap-2 shadow-lg hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                    </svg>
                    Hide Borewells
                </button>
            </div>
                        <div id="borewellStatus" class="mb-3 text-sm font-medium hidden"></div>
                        
                        <!-- Map Container with proper styling -->
                        <div id="map" class="w-full rounded-2xl overflow-hidden shadow-lg border-2 border-gray-200" style="height: 500px;"></div>
                        
                        <!-- Area Prediction Button -->
                        <button type="button" id="predictAreaBtn" class="mt-4 w-full bg-gradient-to-r from-green-600 to-teal-600 text-white py-4 px-6 rounded-xl hover:from-green-700 hover:to-teal-700 transition-all duration-300 text-lg font-semibold hidden flex items-center justify-center gap-3 shadow-lg hover:shadow-xl btn-hover">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                            </svg>
                            <span>Predict Groundwater Levels in Selected Area</span>
                            <span class="bg-yellow-400 text-gray-900 text-xs px-3 py-1 rounded-full font-bold">LIVE DATA</span>
                        </button>
                        <div id="areaPredictionStatus" class="mt-3 text-center text-sm font-medium hidden"></div>
                        
                        <!-- AI Recommend Button -->
                        <button type="button" id="aiRecommendBtn" class="mt-3 w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 px-6 rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all duration-300 text-lg font-semibold hidden flex items-center justify-center gap-3 shadow-lg hover:shadow-xl btn-hover">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                            <span>🤖 AI Recommend Best Sites</span>
                            <span class="bg-yellow-400 text-gray-900 text-xs px-3 py-1 rounded-full font-bold">AI POWERED</span>
                        </button>
                        <div id="aiRecommendStatus" class="mt-3 text-center text-sm font-medium hidden"></div>
                        
                        <!-- RAG Chatbot Button -->
                        <button type="button" id="ragChatbotBtn" class="mt-3 w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 px-6 rounded-xl hover:from-blue-700 hover:to-cyan-700 transition-all duration-300 text-lg font-semibold flex items-center justify-center gap-3 shadow-lg hover:shadow-xl btn-hover">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                            </svg>
                            <span>💬 AI Document Chat</span>
                            <span class="bg-green-400 text-gray-900 text-xs px-3 py-1 rounded-full font-bold">PDF Q&A</span>
                        </button>
                    </div>

                    <!-- Weather Information Panel -->
                    <div id="weatherPanel" class="mb-8 bg-gradient-to-br from-blue-50 via-cyan-50 to-teal-50 dark:from-blue-900/20 dark:via-cyan-900/20 dark:to-teal-900/20 border-2 border-blue-200 dark:border-blue-800 rounded-2xl p-6 shadow-xl hidden card-hover page-section">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-3">
                <div class="flex items-center">
                    <div class="p-3 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl shadow-lg mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Real-Time Weather Data</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Live from IMD & WRIS stations</p>
                    </div>
                </div>
                <span class="flex items-center gap-2 bg-green-500 text-white text-sm font-semibold px-4 py-2 rounded-full shadow-lg">
                    <span class="w-2 h-2 bg-white rounded-full animate-pulse-slow"></span>
                    LIVE DATA
                </span>
            </div>
            
            <div id="weatherContent">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-600 dark:text-gray-300 text-sm font-semibold">Rainfall</span>
                            <span class="text-3xl">🌧️</span>
                        </div>
                        <div id="weatherRainfall" class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-cyan-600 dark:from-blue-400 dark:to-cyan-400 bg-clip-text text-transparent">--</div>
                        <div class="text-gray-500 dark:text-gray-400 text-sm mt-1 font-medium">millimeters</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-600 dark:text-gray-300 text-sm font-semibold">Temperature</span>
                            <span class="text-3xl">🌡️</span>
                        </div>
                        <div id="weatherTemp" class="text-3xl font-bold bg-gradient-to-r from-orange-600 to-red-600 dark:from-orange-400 dark:to-red-400 bg-clip-text text-transparent">--</div>
                        <div class="text-gray-500 dark:text-gray-400 text-sm mt-1 font-medium">degrees Celsius</div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-600 dark:text-gray-300 text-sm font-semibold">River Level</span>
                            <span class="text-3xl">💧</span>
                        </div>
                        <div id="weatherRiver" class="text-3xl font-bold bg-gradient-to-r from-cyan-600 to-blue-600 dark:from-cyan-400 dark:to-blue-400 bg-clip-text text-transparent">--</div>
                        <div class="text-gray-500 dark:text-gray-400 text-sm mt-1 font-medium">meters</div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg mb-4">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="flex flex-col">
                            <span class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">📅 Season</span>
                            <span id="weatherSeason" class="text-blue-600 dark:text-blue-400 font-bold text-lg">--</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">📡 Data Source</span>
                            <span id="weatherSource" class="text-gray-700 dark:text-gray-200 font-semibold text-sm">IMD/WRIS (Nashik)</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-1">🕐 Last Updated</span>
                            <span id="weatherTimestamp" class="text-gray-700 dark:text-gray-200 font-semibold text-sm">--</span>
                        </div>
                    </div>
                </div>
                
                <div id="nearestStations" class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg hidden">
                    <div class="font-bold text-gray-800 dark:text-gray-100 mb-3 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        </svg>
                        Nearest Weather Stations
                    </div>
                    <div id="stationsList" class="text-sm text-gray-600 dark:text-gray-300 space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- Prediction Form -->
                    <form method="POST" action="/" id="predictionForm" class="space-y-6 page-section">
            <div id="predictions" class="flex items-center mb-6">
                <div class="p-3 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl shadow-lg mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Prediction Parameters</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Auto-filled from real-time data</p>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label for="latitude" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">📍 Latitude</label>
                    <input type="number" step="any" name="latitude" id="latitude" required readonly
                           placeholder="Select on map"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
                <div>
                    <label for="longitude" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">📍 Longitude</label>
                    <input type="number" step="any" name="longitude" id="longitude" required readonly
                           placeholder="Select on map"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label for="rainfall" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">🌧️ Rainfall (mm)</label>
                    <input type="number" step="any" name="rainfall" id="rainfall" required readonly
                           placeholder="0.00"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
                <div>
                    <label for="river_water_level" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">💧 River Water Level (m)</label>
                    <input type="number" step="any" name="river_water_level" id="river_water_level" required readonly
                           placeholder="0.00"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label for="temperature" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">🌡️ Temperature (°C)</label>
                    <input type="number" step="any" name="temperature" id="temperature" required readonly
                           placeholder="0.00"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
                <div>
                    <label for="rainfall_lag1" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">🌧️ Rainfall Lag1 (mm)</label>
                    <input type="number" step="any" name="rainfall_lag1" id="rainfall_lag1" required readonly
                           placeholder="0.00"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div>
                    <label for="river_lag1" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">💧 River Lag1 (m)</label>
                    <input type="number" step="any" name="river_lag1" id="river_lag1" required readonly
                           placeholder="0.00"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
                <div>
                    <label for="data_time" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-2">📅 Data Time</label>
                    <input type="text" name="data_time" id="data_time" required readonly
                           placeholder="2025-09-18 19:42"
                           class="block w-full rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 shadow-sm text-base py-3 px-4 focus:border-blue-500 dark:focus:border-blue-400 focus:ring-4 focus:ring-blue-100 dark:focus:ring-blue-900/30 transition-all">
                </div>
            </div>
            <button type="submit" id="predictButton" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 px-6 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 text-lg font-bold shadow-lg hover:shadow-2xl btn-hover flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span>Predict Groundwater Level</span>
            </button>
            
            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="hidden text-center mt-6">
                <div class="flex items-center justify-center gap-3 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-xl">
                    <svg class="animate-spin h-7 w-7 text-blue-600 dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-blue-700 dark:text-blue-300 font-semibold text-lg">Analyzing groundwater data...</span>
                </div>
            </div>
        </form>

        <!-- Prediction Result Container (Dynamic - No Page Refresh) -->
        <div id="predictionResultContainer" class="hidden mt-8"></div>
                    
                </div>
            </div>
    
    <!-- Footer -->
    <footer class="mt-12 pb-8 text-center text-gray-600 dark:text-gray-400 transition-colors">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4 p-6 bg-white rounded-2xl shadow-lg">
                <div class="text-left">
                    <p class="font-semibold text-gray-800">Groundwater AI - Nashik District</p>
                    <p class="text-sm text-gray-500">Powered by Machine Learning & Real-Time Data</p>
                </div>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-gray-600">Last Updated:</span>
                    <span id="lastUpdated" class="text-sm font-semibold text-blue-600">--</span>
                </div>
            </div>
            <p class="mt-4 text-sm">© 2025 Groundwater Prediction System. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const htmlElement = document.documentElement;
        
        // Check for saved theme preference or default to light mode
        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            htmlElement.classList.add('dark');
        }
        
        // Update dark mode button icon
        function updateDarkModeIcon() {
            const isDark = htmlElement.classList.contains('dark');
            darkModeToggle.innerHTML = isDark 
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                     <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" />
                   </svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                   </svg>`;
        }
        
        updateDarkModeIcon();
        
        // Toggle dark mode
        darkModeToggle.addEventListener('click', function() {
            htmlElement.classList.toggle('dark');
            const theme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            updateDarkModeIcon();
        });
        
        // Mobile Menu Toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('hidden');
        });
        
        // Smooth scroll for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Close mobile menu if open
                    document.getElementById('mobileMenu').classList.add('hidden');
                }
            });
        });
        
        // Intersection Observer for fade-in animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);
        
        // Observe all page sections
        document.querySelectorAll('.page-section').forEach(section => {
            observer.observe(section);
        });
        
        // Update last updated timestamp
        document.getElementById('lastUpdated').textContent = new Date().toLocaleString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Initialize Leaflet map centered on Nashik (20.0, 73.79)
        const map = L.map('map').setView([20.0, 73.79], 13);
        
        // Satellite view with labels - shows buildings, roads, trees, terrain
        L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            attribution: '&copy; <a href="https://www.google.com/maps">Google Maps</a>',
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        }).addTo(map);

        // Layer for drawn items
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Add drawing controls (only rectangle)
        const drawControl = new L.Control.Draw({
            draw: {
                rectangle: {
                    shapeOptions: {
                        color: '#4F46E5',
                        weight: 3,
                        fillOpacity: 0.2
                    }
                },
                polygon: false,
                polyline: false,
                circle: false,
                circlemarker: false,
                marker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        // Marker for selected location
        let marker = null;
        let accuracyCircle = null; // Track GPS accuracy circle
        let locationRing = null; // Track inner location ring for better visibility
        let currentRectangleBounds = null;
        let predictionMarkers = [];
        let boundaryLayer = null;
        let borewellMarkers = [];
        let borewellsVisible = false;

        // Generate random values for other parameters
        function generateRandomParams() {
            const randomInRange = (min, max) => (Math.random() * (max - min) + min).toFixed(2);
            document.getElementById('rainfall').value = randomInRange(0, 100); // Rainfall: 0-100 mm
            document.getElementById('river_water_level').value = randomInRange(0, 10); // River Water Level: 0-10 m
            document.getElementById('temperature').value = randomInRange(15, 35); // Temperature: 15-35°C
            document.getElementById('rainfall_lag1').value = randomInRange(0, 100); // Rainfall Lag1: 0-100 mm
            document.getElementById('river_lag1').value = randomInRange(0, 10); // River Lag1: 0-10 m

            // Set Data Time to current date/time
            const now = new Date();
            const dateTimeStr = now.toISOString().slice(0, 16).replace('T', ' ');
            document.getElementById('data_time').value = dateTimeStr;
        }

        // Clear prediction markers
        function clearPredictionMarkers() {
            predictionMarkers.forEach(m => map.removeLayer(m));
            predictionMarkers = [];
        }

        // Handle rectangle drawn event
        map.on(L.Draw.Event.CREATED, function(e) {
            const layer = e.layer;
            drawnItems.clearLayers(); // Clear previous rectangles
            clearPredictionMarkers(); // Clear old prediction markers
            drawnItems.addLayer(layer);

            // Store bounds for area prediction
            currentRectangleBounds = layer.getBounds();

            // Show area prediction button and AI recommend button
            document.getElementById('predictAreaBtn').classList.remove('hidden');
            document.getElementById('aiRecommendBtn').classList.remove('hidden');
            document.getElementById('areaPredictionStatus').classList.add('hidden');
            document.getElementById('aiRecommendStatus').classList.add('hidden');

            // Get center of rectangle
            const bounds = layer.getBounds();
            const center = bounds.getCenter();
            const lat = center.lat.toFixed(4);
            const lng = center.lng.toFixed(4);

            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            // Generate random parameters
            generateRandomParams();

            // Add or update marker at center
            if (marker) {
                marker.setLatLng(center);
            } else {
                marker = L.marker(center, {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map);
            }
        });

        // Update lat/lng and generate random params on map click
        map.on('click', function(e) {
            const lat = e.latlng.lat.toFixed(4);
            const lng = e.latlng.lng.toFixed(4);
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            // Generate random parameters after map click
            generateRandomParams();

            // Remove GPS accuracy circle when manually clicking
            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
                accuracyCircle = null;
            }

            // Update or add marker
            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng).addTo(map);
            }
            
            // Auto-load borewells within 20km of clicked location
            autoLoadNearbyBorewells(parseFloat(lat), parseFloat(lng), `(${lat}, ${lng})`);
        });

        // Handle form submission with AJAX (No page refresh!)
        document.getElementById('predictionForm').addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevent form from submitting and refreshing page
            
            // Show loading, hide button
            document.getElementById('predictButton').disabled = true;
            document.getElementById('predictButton').innerHTML = `
                <svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Predicting...</span>
            `;
            document.getElementById('loadingSpinner').classList.remove('hidden');
            
            // Hide any previous results
            document.getElementById('predictionResultContainer').classList.add('hidden');
            
            try {
                // Collect form data
                const formData = new FormData(this);
                
                // Send AJAX request
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // Hide loading
                document.getElementById('loadingSpinner').classList.add('hidden');
                
                // Reset button
                document.getElementById('predictButton').disabled = false;
                document.getElementById('predictButton').innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>Predict Groundwater Level</span>
                `;
                
                // Display result
                const resultContainer = document.getElementById('predictionResultContainer');
                
                if (result.success) {
                    // Success - Show prediction
                    resultContainer.innerHTML = `
                        <div class="p-6 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-2xl border-2 border-green-300 dark:border-green-700 shadow-lg animate-fadeInUp">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="p-3 bg-green-500 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-green-800 dark:text-green-300">Prediction Complete</h3>
                                    <p class="text-sm text-green-600 dark:text-green-400">
                                        AI model confidence: <span id="confidence-value">${result.confidence}%</span>
                                        <span class="ml-2" id="confidence-indicator"></span>
                                    </p>
                                </div>
                            </div>
                            <p class="text-green-900 dark:text-green-100 font-bold text-2xl">
                                Predicted Groundwater Level: 
                                <span class="text-3xl bg-gradient-to-r from-green-600 to-emerald-600 dark:from-green-400 dark:to-emerald-400 bg-clip-text text-transparent">
                                    ${result.prediction} meters
                                </span>
                            </p>
                        </div>
                    `;
                    resultContainer.classList.remove('hidden');
                    
                    // Add confidence indicator with color coding
                    setTimeout(() => {
                        const confidenceValue = result.confidence;
                        const confidenceIndicator = document.getElementById('confidence-indicator');
                        
                        if (confidenceValue >= 90) {
                            confidenceIndicator.innerHTML = '🟢 Excellent';
                            confidenceIndicator.className = 'ml-2 text-green-600 dark:text-green-400 font-semibold';
                        } else if (confidenceValue >= 80) {
                            confidenceIndicator.innerHTML = '🟡 Very Good';
                            confidenceIndicator.className = 'ml-2 text-yellow-600 dark:text-yellow-400 font-semibold';
                        } else if (confidenceValue >= 70) {
                            confidenceIndicator.innerHTML = '🟠 Good';
                            confidenceIndicator.className = 'ml-2 text-orange-600 dark:text-orange-400 font-semibold';
                        } else if (confidenceValue >= 60) {
                            confidenceIndicator.innerHTML = '🟤 Fair';
                            confidenceIndicator.className = 'ml-2 text-amber-700 dark:text-amber-500 font-semibold';
                        } else {
                            confidenceIndicator.innerHTML = '🔴 Low';
                            confidenceIndicator.className = 'ml-2 text-red-600 dark:text-red-400 font-semibold';
                        }
                    }, 100);
                    
                    // Scroll to result smoothly
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                } else {
                    // Error - Show error message
                    resultContainer.innerHTML = `
                        <div class="p-6 bg-gradient-to-r from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 rounded-2xl border-2 border-red-300 dark:border-red-700 shadow-lg animate-fadeInUp">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="p-3 bg-red-500 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-red-800 dark:text-red-300">Error Occurred</h3>
                                </div>
                            </div>
                            <p class="text-red-900 dark:text-red-100 font-semibold text-lg">${result.error}</p>
                        </div>
                    `;
                    resultContainer.classList.remove('hidden');
                    
                    // Scroll to error
                    resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                
            } catch (error) {
                console.error('Prediction error:', error);
                
                // Hide loading
                document.getElementById('loadingSpinner').classList.add('hidden');
                
                // Reset button
                document.getElementById('predictButton').disabled = false;
                document.getElementById('predictButton').innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>Predict Groundwater Level</span>
                `;
                
                // Show error
                const resultContainer = document.getElementById('predictionResultContainer');
                resultContainer.innerHTML = `
                    <div class="p-6 bg-gradient-to-r from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 rounded-2xl border-2 border-red-300 dark:border-red-700 shadow-lg">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="p-3 bg-red-500 rounded-xl">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-red-800 dark:text-red-300">Network Error</h3>
                            </div>
                        </div>
                        <p class="text-red-900 dark:text-red-100 font-semibold text-lg">Failed to connect to server. Please check your connection and try again.</p>
                    </div>
                `;
                resultContainer.classList.remove('hidden');
            }
        });

        // GPS Location Handler - Use My Location Button
        document.getElementById('useMyLocationBtn').addEventListener('click', function() {
            const statusEl = document.getElementById('locationStatus');
            const btn = this;
            
            // Check if geolocation is supported
            if (!navigator.geolocation) {
                statusEl.innerHTML = '<span class="text-red-600">❌ Geolocation is not supported by your browser</span>';
                statusEl.classList.remove('hidden');
                return;
            }

            // Show loading status
            statusEl.innerHTML = '<span class="text-blue-600">📡 Getting your location...</span>';
            statusEl.classList.remove('hidden');
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Getting Location...';

            // Get current position
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    // Update form fields
                    document.getElementById('latitude').value = lat.toFixed(4);
                    document.getElementById('longitude').value = lon.toFixed(4);

                    // Generate random parameters
                    generateRandomParams();

                    // Update map and add marker
                    map.setView([lat, lon], 15);
                    
                    if (marker) {
                        marker.setLatLng([lat, lon]);
                    } else {
                        marker = L.marker([lat, lon], {
                            icon: L.icon({
                                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).addTo(map);
                    }

                    marker.bindPopup(`<b>📍 Your Location</b><br>Lat: ${lat.toFixed(4)}<br>Lon: ${lon.toFixed(4)}<br>Accuracy: ±${accuracy.toFixed(0)}m`).openPopup();

                    // Remove old accuracy circle if exists
                    if (accuracyCircle) {
                        map.removeLayer(accuracyCircle);
                    }

                    // Remove old location ring if exists
                    if (locationRing) {
                        map.removeLayer(locationRing);
                    }

                    // Add enhanced accuracy circle - STATIC (NO ANIMATION)
                    accuracyCircle = L.circle([lat, lon], {
                        color: '#3B82F6',           // Bright blue border
                        fillColor: '#60A5FA',       // Lighter blue fill
                        fillOpacity: 0.25,          // More visible
                        weight: 3,                  // Thicker border
                        opacity: 0.8,               // More opaque border
                        radius: Math.max(accuracy, 150), // Minimum 150m radius for better visibility
                        // NO className - keeps circle static
                    }).addTo(map);

                    // Add a prominent inner ring around your exact location - STATIC
                    locationRing = L.circle([lat, lon], {
                        color: '#2563EB',           // Darker blue border
                        fillColor: '#3B82F6',       // Bright blue fill
                        fillOpacity: 0.4,           // Semi-transparent
                        weight: 4,                  // Thick border
                        opacity: 1,                 // Fully opaque border
                        radius: 50,                 // Fixed 50m radius for visibility
                        // NO className - keeps circle static
                    }).addTo(map);

                    // Animation CSS removed - circles are now STATIC (no movement)

                    // Success status with enhanced message
                    const radiusKm = (Math.max(accuracy, 150) / 1000).toFixed(2);
                    statusEl.innerHTML = `<span class="text-green-600">✅ Location found! Accuracy: ±${accuracy.toFixed(0)}m<br>🔵 Blue circles show your location area (${radiusKm}km radius)</span>`;
                    
                    // Reset button
                    btn.disabled = false;
                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Use My Location';
                    
                    // Auto-load borewells within 20km of GPS location
                    setTimeout(() => {
                        autoLoadNearbyBorewells(lat, lon, 'Your Location');
                    }, 500);
                },
                function(error) {
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = "❌ Location access denied. Please enable location permissions.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = "❌ Location information unavailable.";
                            break;
                        case error.TIMEOUT:
                            errorMsg = "❌ Location request timed out.";
                            break;
                        default:
                            errorMsg = "❌ An unknown error occurred.";
                            break;
                    }
                    statusEl.innerHTML = `<span class="text-red-600">${errorMsg}</span>`;
                    
                    // Reset button
                    btn.disabled = false;
                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Use My Location';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });

        // ========== AI-POWERED SEARCH WITH GEMINI ==========
        
        // Cache for AI suggestions to reduce API calls
        let aiSuggestionsCache = {};
        let lastSearchQuery = '';
        let searchDebounceTimer = null;
        
        // Recent searches (stored in memory)
        let recentSearches = [];
        
        // Currently selected suggestion index
        let selectedSuggestionIndex = -1;
        let currentSuggestions = [];
        
        // Fetch AI-powered suggestions from Gemini
        async function fetchAISuggestions(query, maxResults = 10) {
            // Check cache first
            const cacheKey = `${query}_${maxResults}`;
            if (aiSuggestionsCache[cacheKey]) {
                console.log('� Using cached AI suggestions for:', query);
                return aiSuggestionsCache[cacheKey];
            }
            
            try {
                console.log('🤖 Fetching AI suggestions for:', query);
                const response = await fetch('/ai_search_suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, max_results: maxResults })
                });
                
                const result = await response.json();
                
                if (result.success && result.suggestions) {
                    // Cache the results
                    aiSuggestionsCache[cacheKey] = result.suggestions;
                    console.log(`✅ Got ${result.suggestions.length} AI suggestions`);
                    return result.suggestions;
                } else {
                    console.error('❌ AI search failed:', result.error);
                    return [];
                }
            } catch (error) {
                console.error('❌ Error fetching AI suggestions:', error);
                return [];
            }
        }
        
        // Show suggestions dropdown
        function showSuggestions(locations, query = '') {
            const dropdown = document.getElementById('suggestionsDropdown');
            const listEl = document.getElementById('suggestionsList');
            
            if (locations.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            
            currentSuggestions = locations;
            selectedSuggestionIndex = -1;
            
            let html = '';
            
            // Show "Recent Searches" header if applicable
            if (!query && recentSearches.length > 0) {
                html += `
                    <div class="px-4 py-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                        <span class="text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">🕐 Recent Searches</span>
                    </div>
                `;
                
                recentSearches.slice(0, 3).forEach((loc, idx) => {
                    html += `
                        <div class="suggestion-item px-4 py-3 hover:bg-indigo-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 transition duration-150" data-index="${idx}">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-semibold text-gray-800 dark:text-gray-100">${loc.name}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${loc.category}</div>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                        </div>
                    `;
                });
                
                if (locations.length > 0) {
                    html += `
                        <div class="px-4 py-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 mt-2">
                            <span class="text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase">⭐ Popular Locations</span>
                        </div>
                    `;
                }
            }
            
            // Group by category
            const grouped = {};
            locations.forEach(loc => {
                if (!grouped[loc.category]) grouped[loc.category] = [];
                grouped[loc.category].push(loc);
            });
            
            // Display suggestions
            let globalIndex = recentSearches.length > 0 ? recentSearches.slice(0, 3).length : 0;
            Object.keys(grouped).forEach(category => {
                if (!query) {
                    html += `
                        <div class="px-4 py-2 bg-gradient-to-r from-indigo-50 to-blue-50 dark:from-gray-700 dark:to-gray-600 border-b border-indigo-100 dark:border-gray-600">
                            <span class="text-xs font-semibold text-indigo-700 dark:text-indigo-300 uppercase">${category}</span>
                        </div>
                    `;
                }
                
                grouped[category].forEach(loc => {
                    const displayName = query ? highlightMatch(loc.name, query) : loc.name;
                    
                    // Build badges HTML
                    let badgesHtml = '';
                    if (loc.popular) {
                        badgesHtml += '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 dark:bg-amber-900/40 text-amber-800 dark:text-amber-300 mr-1">⭐ Popular</span>';
                    }
                    if (loc.trending) {
                        badgesHtml += '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-pink-100 dark:bg-pink-900/40 text-pink-800 dark:text-pink-300 mr-1">🔥 Trending</span>';
                    }
                    
                    // Build description HTML
                    const descHtml = loc.description ? `<div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${loc.description}</div>` : '';
                    
                    html += `
                        <div class="suggestion-item px-4 py-3 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 dark:hover:from-gray-700 dark:hover:to-gray-600 cursor-pointer border-b border-gray-100 dark:border-gray-700 transition duration-200" data-index="${globalIndex}">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <div class="font-semibold text-gray-800 dark:text-gray-100 text-base">${displayName}</div>
                                        ${badgesHtml}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">${loc.category}</span>
                                    </div>
                                    ${descHtml}
                                </div>
                                <div class="flex flex-col items-end ml-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-400 dark:text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    <span class="text-xs text-gray-400 dark:text-gray-500 mt-1">Click to view</span>
                                </div>
                            </div>
                        </div>
                    `;
                    globalIndex++;
                });
            });
            
            // Footer with count
            html += `
                <div class="px-4 py-2 bg-gray-50 dark:bg-gray-700 text-center">
                    <span class="text-xs text-gray-500 dark:text-gray-400">${locations.length} location${locations.length !== 1 ? 's' : ''} available</span>
                </div>
            `;
            
            listEl.innerHTML = html;
            dropdown.classList.remove('hidden');
            
            // Add click handlers
            document.querySelectorAll('.suggestion-item').forEach((item, idx) => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    let selectedLoc;
                    
                    if (!query && index < recentSearches.length) {
                        selectedLoc = recentSearches[index];
                    } else {
                        const adjustedIndex = (!query && recentSearches.length > 0) ? index - recentSearches.slice(0, 3).length : index;
                        selectedLoc = currentSuggestions[adjustedIndex];
                    }
                    
                    selectLocation(selectedLoc);
                });
                
                // Hover effect for keyboard navigation
                item.addEventListener('mouseenter', () => {
                    document.querySelectorAll('.suggestion-item').forEach(el => el.classList.remove('bg-indigo-50'));
                    item.classList.add('bg-indigo-50');
                    selectedSuggestionIndex = parseInt(item.dataset.index);
                });
            });
        }
        
        // Highlight matching text
        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="bg-yellow-200 font-semibold">$1</span>');
        }
        
        // Filter locations based on query (ENHANCED)
        // AI-powered location filtering (replaces static array search)
        async function filterLocations(query) {
            if (!query) {
                // Show popular locations when no query
                try {
                    const response = await fetch('/ai_search_suggestions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: '', max_results: 10 })
                    });
                    const data = await response.json();
                    if (data.success) {
                        return data.suggestions.map(s => ({
                            name: s.name,
                            category: s.category,
                            description: s.description,
                            popular: s.popular,
                            lat: s.lat,
                            lon: s.lon
                        }));
                    }
                } catch (error) {
                    console.error('Error fetching popular locations:', error);
                }
                return [];
            }
            
            // Use AI suggestions
            const suggestions = await fetchAISuggestions(query, 15);
            return suggestions;
        }
        
        // Select a location from suggestions
        function selectLocation(location) {
            const searchInput = document.getElementById('locationSearch');
            searchInput.value = location.name;
            document.getElementById('suggestionsDropdown').classList.add('hidden');
            
            // Add to recent searches (avoid duplicates)
            recentSearches = recentSearches.filter(loc => loc.name !== location.name);
            recentSearches.unshift(location);
            if (recentSearches.length > 5) recentSearches.pop();
            
            // If location has coordinates, use them directly
            if (location.lat && location.lon) {
                console.log('✅ Using coordinates from AI suggestion:', location.lat, location.lon);
                
                const resultsEl = document.getElementById('searchResults');
                resultsEl.innerHTML = `<span class="text-green-600">✅ Found: <b>${location.name}</b><br>${location.description || ''}</span>`;
                
                // Update map
                map.setView([location.lat, location.lon], 14);
                
                // Add/update marker
                if (marker) {
                    marker.setLatLng([location.lat, location.lon]);
                } else {
                    marker = L.marker([location.lat, location.lon], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                }
                
                // Create popup with location name and description (not category to avoid confusion)
                const popupContent = location.description 
                    ? `<b>${location.name}</b><br><small>${location.description}</small>`
                    : `<b>${location.name}</b>`;
                marker.bindPopup(popupContent).openPopup();
                
                // Update form
                document.getElementById('latitude').value = location.lat.toFixed(4);
                document.getElementById('longitude').value = location.lon.toFixed(4);
                generateRandomParams();
                
                // Auto-load borewells within 20km
                setTimeout(() => {
                    loadBorewellsInRadius(location.lat, location.lon, 20);
                }, 300);
                
                // Try to fetch boundary in background (optional)
                fetchBoundaryInBackground(location.name);
            } else {
                // Fallback to original search if no coordinates
                searchLocation();
            }
        }
        
        // Fetch boundary in background (optional, non-blocking)
        async function fetchBoundaryInBackground(locationName) {
            try {
                const response = await fetch('/get_boundary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ location_name: locationName })
                });
                
                const result = await response.json();
                
                if (result.success && result.boundary) {
                    // Remove old boundary if exists
                    if (boundaryLayer) {
                        map.removeLayer(boundaryLayer);
                    }
                    
                    // Draw boundary
                    boundaryLayer = L.geoJSON(result.boundary, {
                        style: {
                            color: '#3B82F6',
                            weight: 4,
                            opacity: 1,
                            fillColor: '#3B82F6',
                            fillOpacity: 0.2
                        }
                    }).addTo(map);
                    
                    boundaryLayer.bindPopup(`<b>🔵 ${result.display_name}</b><br><small>Administrative Boundary</small>`);
                    
                    console.log('✅ Boundary loaded for:', locationName);
                }
            } catch (error) {
                console.log('ℹ️ Boundary not available for:', locationName);
            }
        }
        
        // Setup search input handlers
        const searchInput = document.getElementById('locationSearch');
        const clearBtn = document.getElementById('clearSearchBtn');
        const dropdown = document.getElementById('suggestionsDropdown');
        
        // Show/hide clear button with AI-powered debounced search
        searchInput.addEventListener('input', async (e) => {
            const query = e.target.value.trim();
            
            // Clear previous debounce timer
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }
            
            if (query.length > 0) {
                clearBtn.classList.remove('hidden');
                
                // Show loading state
                showSuggestions([{ 
                    name: '🤖 AI is thinking...', 
                    category: '', 
                    description: 'Searching for ' + query 
                }], query);
                
                // Debounce AI search (300ms delay)
                searchDebounceTimer = setTimeout(async () => {
                    const filtered = await filterLocations(query);
                    showSuggestions(filtered, query);
                }, 300);
            } else {
                clearBtn.classList.add('hidden');
                const popular = await filterLocations('');
                showSuggestions(popular);
            }
        });
        
        // Clear button handler
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearBtn.classList.add('hidden');
            dropdown.classList.add('hidden');
            searchInput.focus();
        });
        
        // Show popular locations on focus (async with AI)
        searchInput.addEventListener('focus', async () => {
            if (searchInput.value.trim().length === 0) {
                const popular = await filterLocations('');
                showSuggestions(popular);
            } else {
                const filtered = await filterLocations(searchInput.value.trim());
                showSuggestions(filtered, searchInput.value.trim());
            }
        });
        
        // Keyboard navigation
        searchInput.addEventListener('keydown', (e) => {
            const items = document.querySelectorAll('.suggestion-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, items.length - 1);
                updateSelectedSuggestion(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSelectedSuggestion(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedSuggestionIndex >= 0 && items[selectedSuggestionIndex]) {
                    items[selectedSuggestionIndex].click();
                } else {
                    searchLocation();
                }
            } else if (e.key === 'Escape') {
                dropdown.classList.add('hidden');
                searchInput.blur();
            }
        });
        
        // Update visual selection
        function updateSelectedSuggestion(items) {
            items.forEach((item, idx) => {
                if (idx === selectedSuggestionIndex) {
                    item.classList.add('bg-indigo-50');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('bg-indigo-50');
                }
            });
        }
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
        
        // Location Search Handler
        async function searchLocation() {
            const query = document.getElementById('locationSearch').value.trim();
            const resultsEl = document.getElementById('searchResults');
            
            if (!query) {
                resultsEl.innerHTML = '<span class="text-red-600">⚠️ Please enter a location name</span>';
                return;
            }

            resultsEl.innerHTML = '<span class="text-gray-600">🔍 Searching and fetching boundary...</span>';

            try {
                // Fetch boundary from backend
                const response = await fetch('/get_boundary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ location_name: query })
                });
                
                const result = await response.json();

                if (!result.success) {
                    resultsEl.innerHTML = `<span class="text-orange-600">❌ ${result.error}</span>`;
                    return;
                }

                const lat = result.center.lat;
                const lon = result.center.lon;

                // Remove old boundary if exists
                if (boundaryLayer) {
                    map.removeLayer(boundaryLayer);
                    boundaryLayer = null;
                }

                // Draw boundary if available
                if (result.boundary) {
                    const geojson = result.boundary;
                    
                    boundaryLayer = L.geoJSON(geojson, {
                        style: {
                            color: '#3B82F6',      // Bright blue color
                            weight: 4,             // Thicker line
                            opacity: 1,            // Full opacity
                            fillColor: '#3B82F6',
                            fillOpacity: 0.2       // More visible fill
                        }
                    }).addTo(map);

                    // Add popup to boundary
                    boundaryLayer.bindPopup(`<b>🔵 ${result.display_name}</b><br><small>Administrative Boundary</small>`);

                    // Zoom to boundary
                    map.fitBounds(boundaryLayer.getBounds(), { padding: [50, 50] });
                    
                    resultsEl.innerHTML = `<span class="text-green-600">✅ Found: <b>${result.display_name}</b><br>🔵 Blue boundary displayed on map</span>`;
                } else {
                    // Just zoom to center if no boundary
                    map.setView([lat, lon], 14);
                    resultsEl.innerHTML = `<span class="text-yellow-600">⚠️ Found: ${result.display_name}<br>Boundary data not available for this location. Showing center point only.</span>`;
                }

                // Add marker
                if (marker) {
                    marker.setLatLng([lat, lon]);
                } else {
                    marker = L.marker([lat, lon], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(map);
                }

                marker.bindPopup(`<b>${result.display_name}</b>`).openPopup();

                // Update form
                document.getElementById('latitude').value = lat.toFixed(4);
                document.getElementById('longitude').value = lon.toFixed(4);
                generateRandomParams();
                
                // Auto-load borewells within 20km of searched location
                setTimeout(() => {
                    autoLoadNearbyBorewells(lat, lon, result.display_name || query);
                }, 500);

            } catch (error) {
                resultsEl.innerHTML = `<span class="text-red-600">❌ Error: ${error.message}</span>`;
            }
        }

        // Search button handler
        document.getElementById('searchBtn').addEventListener('click', searchLocation);

        // ========== CATEGORY FILTER FUNCTIONALITY ==========
        let selectedCategory = 'all';
        
        // Category button handlers
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                // Update selected category
                selectedCategory = this.dataset.category;
                
                // Update button styles
                document.querySelectorAll('.category-btn').forEach(b => {
                    b.classList.remove('border-purple-500', 'dark:border-purple-400', 'bg-purple-100', 'dark:bg-purple-900/50', 'font-bold');
                    b.classList.add('border-gray-200', 'dark:border-gray-600');
                });
                this.classList.remove('border-gray-200', 'dark:border-gray-600');
                this.classList.add('border-purple-500', 'dark:border-purple-400', 'bg-purple-100', 'dark:bg-purple-900/50', 'font-bold');
                
                // Get current search query
                const query = document.getElementById('locationSearch').value.trim();
                
                // If there's a query, search with category filter
                if (query) {
                    await searchWithCategory(query, selectedCategory);
                } else {
                    // Show popular places in this category
                    await showPopularCategory(selectedCategory);
                }
            });
        });
        
        // Search with category filter
        async function searchWithCategory(query, category) {
            const resultsEl = document.getElementById('searchResults');
            const suggestionsEl = document.getElementById('suggestionsList');
            const dropdown = document.getElementById('suggestionsDropdown');
            
            resultsEl.innerHTML = `<span class="text-blue-600 dark:text-blue-400">🔍 Searching ${category === 'all' ? 'all places' : category} matching "${query}"...</span>`;
            
            try {
                // Use Google Maps API for comprehensive search
                const response = await fetch('/maps_search_places', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: query,
                        place_type: category,
                        max_results: 15
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.places.length > 0) {
                    // Show results in dropdown
                    const placesHTML = result.places.map(place => `
                        <div class="suggestion-item px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-none transition-colors" 
                             data-lat="${place.latitude}" 
                             data-lng="${place.longitude}"
                             data-name="${place.name}"
                             data-address="${place.address}">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">${getCategoryIcon(place.category)}</span>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900 dark:text-gray-100">${place.name}</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${place.address || place.vicinity}</div>
                                    ${place.rating ? `
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 px-2 py-0.5 rounded">⭐ ${place.rating}</span>
                                            ${place.user_ratings_total ? `<span class="text-xs text-gray-500 dark:text-gray-400">(${place.user_ratings_total} reviews)</span>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    suggestionsEl.innerHTML = `
                        <div class="px-4 py-2 bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 border-b border-purple-200 dark:border-purple-800 flex items-center justify-between">
                            <span class="text-sm font-semibold text-purple-900 dark:text-purple-200">📍 Found ${result.count} places</span>
                            <span class="text-xs text-purple-700 dark:text-purple-300">Powered by Google Maps</span>
                        </div>
                        ${placesHTML}
                    `;
                    
                    dropdown.classList.remove('hidden');
                    resultsEl.innerHTML = `<span class="text-green-600 dark:text-green-400">✅ Found ${result.count} ${category === 'all' ? 'places' : category} - Click one to view on map</span>`;
                    
                    // Add click handlers to place items
                    document.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const lat = parseFloat(this.dataset.lat);
                            const lng = parseFloat(this.dataset.lng);
                            const name = this.dataset.name;
                            const address = this.dataset.address;
                            
                            // Place marker on map
                            if (marker) {
                                marker.setLatLng([lat, lng]);
                            } else {
                                marker = L.marker([lat, lng], {
                                    icon: L.icon({
                                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41],
                                        popupAnchor: [1, -34],
                                        shadowSize: [41, 41]
                                    })
                                }).addTo(map);
                            }
                            
                            marker.bindPopup(`<b>${name}</b><br>${address}`).openPopup();
                            map.setView([lat, lng], 16);
                            
                            // Update form
                            document.getElementById('latitude').value = lat.toFixed(4);
                            document.getElementById('longitude').value = lng.toFixed(4);
                            document.getElementById('locationSearch').value = name;
                            
                            dropdown.classList.add('hidden');
                            resultsEl.innerHTML = `<span class="text-green-600 dark:text-green-400">✅ Selected: <b>${name}</b></span>`;
                        });
                    });
                    
                } else {
                    resultsEl.innerHTML = `<span class="text-orange-600 dark:text-orange-400">❌ No ${category === 'all' ? 'places' : category} found for "${query}"</span>`;
                    dropdown.classList.add('hidden');
                }
                
            } catch (error) {
                resultsEl.innerHTML = `<span class="text-red-600 dark:text-red-400">❌ Error: ${error.message}</span>`;
                dropdown.classList.add('hidden');
            }
        }
        
        // Show popular places by category
        async function showPopularCategory(category) {
            if (category === 'all') return;
            
            const resultsEl = document.getElementById('searchResults');
            resultsEl.innerHTML = `<span class="text-blue-600 dark:text-blue-400">🏆 Loading popular ${category}...</span>`;
            
            try {
                const response = await fetch('/maps_popular_category', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        category: category,
                        max_results: 15
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.places.length > 0) {
                    const suggestionsEl = document.getElementById('suggestionsList');
                    const dropdown = document.getElementById('suggestionsDropdown');
                    
                    const placesHTML = result.places.map(place => `
                        <div class="suggestion-item px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer border-b border-gray-100 dark:border-gray-700 last:border-none transition-colors" 
                             data-lat="${place.latitude}" 
                             data-lng="${place.longitude}"
                             data-name="${place.name}"
                             data-address="${place.address}">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">${getCategoryIcon(place.category)}</span>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900 dark:text-gray-100">${place.name}</div>
                                    <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${place.address || place.vicinity}</div>
                                    ${place.rating ? `
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 px-2 py-0.5 rounded">⭐ ${place.rating}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    suggestionsEl.innerHTML = `
                        <div class="px-4 py-2 bg-gradient-to-r from-yellow-100 to-orange-100 dark:from-yellow-900/30 dark:to-orange-900/30 border-b border-yellow-200 dark:border-yellow-800">
                            <span class="text-sm font-semibold text-orange-900 dark:text-orange-200">🏆 Popular ${category} in Nashik District</span>
                        </div>
                        ${placesHTML}
                    `;
                    
                    dropdown.classList.remove('hidden');
                    resultsEl.innerHTML = `<span class="text-green-600 dark:text-green-400">✅ Showing ${result.count} popular ${category}</span>`;
                    
                    // Add click handlers
                    document.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const lat = parseFloat(this.dataset.lat);
                            const lng = parseFloat(this.dataset.lng);
                            const name = this.dataset.name;
                            const address = this.dataset.address;
                            
                            if (marker) {
                                marker.setLatLng([lat, lng]);
                            } else {
                                marker = L.marker([lat, lng]).addTo(map);
                            }
                            
                            marker.bindPopup(`<b>${name}</b><br>${address}`).openPopup();
                            map.setView([lat, lng], 16);
                            
                            document.getElementById('latitude').value = lat.toFixed(4);
                            document.getElementById('longitude').value = lng.toFixed(4);
                            document.getElementById('locationSearch').value = name;
                            
                            dropdown.classList.add('hidden');
                        });
                    });
                }
                
            } catch (error) {
                resultsEl.innerHTML = `<span class="text-red-600 dark:text-red-400">❌ Error loading ${category}</span>`;
            }
        }
        
        // Get category icon
        function getCategoryIcon(category) {
            const icons = {
                'school': '🎓',
                'bank': '🏦',
                'shop': '🛍️',
                'hospital': '🏥',
                'temple': '🕉️',
                'mosque': '🕌',
                'church': '⛪',
                'restaurant': '🍽️',
                'hotel': '🏨',
                'village': '🏘️',
                'city': '🏙️',
                'government': '🏛️',
                'police': '👮',
                'other': '📍'
            };
            return icons[category] || '📍';
        }

        // Area Prediction Button Handler
        document.getElementById('predictAreaBtn').addEventListener('click', async function() {
            if (!currentRectangleBounds) {
                alert('Please draw a rectangle on the map first!');
                return;
            }

            // Show status
            const statusEl = document.getElementById('areaPredictionStatus');
            statusEl.textContent = '⏳ Analyzing area and predicting groundwater levels...';
            statusEl.classList.remove('hidden');
            
            // Clear old markers
            clearPredictionMarkers();

            const bounds = currentRectangleBounds;
            const payload = {
                north: bounds.getNorth(),
                south: bounds.getSouth(),
                east: bounds.getEast(),
                west: bounds.getWest()
            };

            try {
                const response = await fetch('/predict_area', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    const stats = result.statistics;
                    
                    // Add color-coded markers for each prediction
                    result.predictions.forEach(pred => {
                        let color, iconUrl, iconSize;
                        
                        // Special styling for Top 5
                        if (pred.is_top) {
                            // Top 5 get GOLD stars with numbers
                            iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png';
                            iconSize = [30, 49];  // Larger for top spots
                        } else {
                            // Regular markers by category
                            if (pred.category === 'low') {
                                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
                            } else if (pred.category === 'medium') {
                                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png';
                            } else {
                                iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png';
                            }
                            iconSize = [20, 33];
                        }

                        const m = L.marker([pred.lat, pred.lon], {
                            icon: L.icon({
                                iconUrl: iconUrl,
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: iconSize,
                                iconAnchor: [iconSize[0]/2, iconSize[1]],
                                popupAnchor: [1, -iconSize[1]+10],
                                shadowSize: [iconSize[1], iconSize[1]]
                            })
                        }).addTo(map);

                        // Enhanced popup with ranking info
                        let popupContent = '<div style="text-align: center; min-width: 150px;">';
                        if (pred.is_top) {
                            popupContent += `<div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: white; padding: 8px; border-radius: 8px 8px 0 0; margin: -10px -10px 8px -10px;">
                                <strong style="font-size: 18px;">⭐ RANK #${pred.rank} ⭐</strong><br>
                                <span style="font-size: 12px;">TOP RECOMMENDED SPOT</span>
                            </div>`;
                        }
                        popupContent += `
                            <strong style="font-size: 16px; color: ${pred.category === 'high' ? '#10B981' : pred.category === 'medium' ? '#F59E0B' : '#EF4444'};">
                                ${pred.category.toUpperCase()}
                            </strong><br>
                            <strong style="font-size: 18px;">Level: ${pred.value}m</strong><br>
                            <hr style="margin: 8px 0;">
                            <small>Lat: ${pred.lat}<br>Lon: ${pred.lon}</small>
                        `;
                        if (pred.is_top) {
                            popupContent += `
                                <br><button onclick="navigator.clipboard.writeText('${pred.lat}, ${pred.lon}')" 
                                    style="background: #3B82F6; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin-top: 4px;">
                                    📋 Copy Location
                                </button>
                            `;
                        }
                        popupContent += '</div>';
                        
                        m.bindPopup(popupContent);

                        // Add numbered label for top 5
                        if (pred.is_top) {
                            const numberIcon = L.divIcon({
                                className: 'number-label',
                                html: `<div style="
                                    background: #FFD700;
                                    color: #000;
                                    font-weight: bold;
                                    border-radius: 50%;
                                    width: 24px;
                                    height: 24px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    border: 2px solid white;
                                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                    font-size: 14px;
                                ">${pred.rank}</div>`,
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            });
                            
                            L.marker([pred.lat, pred.lon], {icon: numberIcon}).addTo(map);
                        }

                        predictionMarkers.push(m);
                    });

                    // Enhanced status display with statistics and Top 5 list
                    statusEl.innerHTML = `
                        <div style="background: #F0FDF4; border: 2px solid #10B981; border-radius: 8px; padding: 12px; margin-top: 8px;">
                            <div style="font-size: 16px; font-weight: bold; color: #065F46; margin-bottom: 8px;">
                                ✅ Analysis Complete: ${stats.total_points} Points Analyzed
                            </div>
                            
                            <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                                <strong>📊 Area Statistics:</strong><br>
                                Average Level: <strong>${stats.avg_level}m</strong> | 
                                Max: <strong>${stats.max_level}m</strong> | 
                                Min: <strong>${stats.min_level}m</strong><br>
                                🟢 High: ${stats.high_count} | 🟠 Medium: ${stats.medium_count} | 🔴 Low: ${stats.low_count}
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: white; padding: 12px; border-radius: 6px; margin-bottom: 8px;">
                                <strong style="font-size: 16px;">⭐ TOP 5 RECOMMENDED DRILLING LOCATIONS ⭐</strong>
                            </div>
                            
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: left;">
                                ${result.top_5.map((spot, idx) => `
                                    <div style="margin: 6px 0; padding: 8px; background: ${idx === 0 ? '#FEF3C7' : '#F9FAFB'}; border-radius: 4px; border-left: 4px solid #FFD700;">
                                        <strong>#${spot.rank}: ${spot.value}m</strong> 
                                        <span style="color: #6B7280; font-size: 13px;">(${spot.lat}, ${spot.lon})</span>
                                        <span style="float: right; background: ${spot.category === 'high' ? '#10B981' : spot.category === 'medium' ? '#F59E0B' : '#EF4444'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                            ${spot.category.toUpperCase()}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="margin-top: 10px;">
                                <button onclick="downloadTop5Report()" style="background: #3B82F6; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-right: 8px;">
                                    📥 Download Top 5 Report
                                </button>
                                <button onclick="copyTop5ToClipboard()" style="background: #10B981; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                    📋 Copy Top 5 Coordinates
                                </button>
                            </div>
                        </div>
                    `;

                    // Store top 5 data globally for download functions
                    window.top5Data = result.top_5;
                    window.statsData = stats;
                    
                    // Load weather data for the center of the area
                    const centerLat = (bounds.getNorth() + bounds.getSouth()) / 2;
                    const centerLon = (bounds.getEast() + bounds.getWest()) / 2;
                    loadWeatherData(centerLat, centerLon);
                    
                } else {
                    statusEl.textContent = '❌ Error: ' + result.error;
                }
            } catch (error) {
                statusEl.textContent = '❌ Error: ' + error.message;
            }
        });

        // Function to download Top 5 report as text file
        function downloadTop5Report() {
            if (!window.top5Data) return;
            
            let report = '═══════════════════════════════════════════════════\n';
            report += '   GROUNDWATER PREDICTION - TOP 5 DRILLING SPOTS\n';
            report += '═══════════════════════════════════════════════════\n\n';
            report += `Generated: ${new Date().toLocaleString()}\n`;
            report += `Region: Nashik, Maharashtra, India\n\n`;
            
            report += '───────────────────────────────────────────────────\n';
            report += '                AREA STATISTICS\n';
            report += '───────────────────────────────────────────────────\n';
            report += `Total Points Analyzed: ${window.statsData.total_points}\n`;
            report += `Average Groundwater Level: ${window.statsData.avg_level} meters\n`;
            report += `Maximum Level: ${window.statsData.max_level} meters\n`;
            report += `Minimum Level: ${window.statsData.min_level} meters\n`;
            report += `High Potential Spots: ${window.statsData.high_count}\n`;
            report += `Medium Potential Spots: ${window.statsData.medium_count}\n`;
            report += `Low Potential Spots: ${window.statsData.low_count}\n\n`;
            
            report += '═══════════════════════════════════════════════════\n';
            report += '           TOP 5 RECOMMENDED LOCATIONS\n';
            report += '═══════════════════════════════════════════════════\n\n';
            
            window.top5Data.forEach(spot => {
                report += `┌─ RANK #${spot.rank} ${spot.rank === 1 ? '⭐ BEST SPOT ⭐' : '────────────────'}\n`;
                report += `│ Groundwater Level: ${spot.value} meters (${spot.category.toUpperCase()})\n`;
                report += `│ Latitude: ${spot.lat}\n`;
                report += `│ Longitude: ${spot.lon}\n`;
                report += `│ Google Maps: https://www.google.com/maps?q=${spot.lat},${spot.lon}\n`;
                report += `└${'─'.repeat(50)}\n\n`;
            });
            
            report += '\n═══════════════════════════════════════════════════\n';
            report += '                  RECOMMENDATIONS\n';
            report += '═══════════════════════════════════════════════════\n';
            report += '1. Start drilling at Rank #1 location for best results\n';
            report += '2. Verify soil conditions before drilling\n';
            report += '3. Consult local borewell experts for depth estimation\n';
            report += '4. Consider monsoon season for optimal water levels\n';
            report += '5. Ensure proper permits from local authorities\n\n';
            
            report += 'Generated by: Groundwater Prediction System\n';
            report += '═══════════════════════════════════════════════════\n';
            
            // Download
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Top5_Borewell_Locations_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Function to copy Top 5 coordinates to clipboard
        function copyTop5ToClipboard() {
            if (!window.top5Data) return;
            
            let text = 'TOP 5 BOREWELL DRILLING LOCATIONS:\n\n';
            window.top5Data.forEach(spot => {
                text += `#${spot.rank}: ${spot.value}m | ${spot.lat}, ${spot.lon}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert('✅ Top 5 coordinates copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // AI Recommend Button Handler
        document.getElementById('aiRecommendBtn').addEventListener('click', async function() {
            if (!currentRectangleBounds) {
                alert('⚠️ Please draw a rectangle on the map first');
                return;
            }

            const statusEl = document.getElementById('aiRecommendStatus');
            statusEl.textContent = '🤖 AI is analyzing best borewell sites...';
            statusEl.className = 'mt-3 text-center text-sm font-medium text-blue-600';
            statusEl.classList.remove('hidden');

            const bounds = currentRectangleBounds;
            const bbox = [
                bounds.getSouth(),  // min_lat
                bounds.getWest(),   // min_lon
                bounds.getNorth(),  // max_lat
                bounds.getEast()    // max_lon
            ];

            try {
                const response = await fetch('/ai_recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bbox: bbox, n: 5, spacing_km: 0.8 })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear existing AI markers and existing borewell markers
                    if (window.aiMarkers) {
                        window.aiMarkers.forEach(m => map.removeLayer(m));
                    }
                    window.aiMarkers = [];
                    
                    if (window.aiExistingBorewells) {
                        window.aiExistingBorewells.forEach(m => map.removeLayer(m));
                    }
                    window.aiExistingBorewells = [];

                    // First, add existing borewells in the region (purple/red markers)
                    if (result.existing_borewells && result.existing_borewells.length > 0) {
                        result.existing_borewells.forEach((bw) => {
                            const isSuccess = bw.status === 'Success';
                            const iconUrl = isSuccess 
                                ? 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png'
                                : 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
                            
                            const bwMarker = L.marker([bw.lat, bw.lon], {
                                icon: L.icon({
                                    iconUrl: iconUrl,
                                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                    iconSize: [25, 41],
                                    iconAnchor: [12, 41],
                                    popupAnchor: [1, -34],
                                    shadowSize: [41, 41]
                                })
                            }).addTo(map);
                            
                            // Popup for existing borewell
                            let bwPopup = `<div style="text-align: left; min-width: 200px;">`;
                            bwPopup += `<div style="background: ${isSuccess ? '#9333EA' : '#EF4444'}; color: white; padding: 8px; border-radius: 8px 8px 0 0; margin: -10px -10px 8px -10px; text-align: center;">
                                <strong style="font-size: 14px;">🏗️ EXISTING BOREWELL</strong>
                            </div>`;
                            bwPopup += `<strong>📍 Location:</strong> ${bw.location}<br>`;
                            bwPopup += `<strong>🆔 ID:</strong> ${bw.id}<br>`;
                            bwPopup += `<strong>📊 Status:</strong> <span style="color: ${isSuccess ? '#10B981' : '#EF4444'}; font-weight: bold;">${bw.status}</span><br>`;
                            bwPopup += `<strong>⚙️ Depth:</strong> ${bw.depth}m<br>`;
                            bwPopup += `<strong>💧 Yield:</strong> ${bw.yield} LPH<br>`;
                            bwPopup += `<strong>💎 Quality:</strong> ${bw.quality}<br>`;
                            bwPopup += `<strong>📅 Year:</strong> ${bw.year}<br>`;
                            bwPopup += `<strong>📌 Coords:</strong> ${bw.lat.toFixed(5)}, ${bw.lon.toFixed(5)}<br>`;
                            bwPopup += `</div>`;
                            
                            bwMarker.bindPopup(bwPopup);
                            window.aiExistingBorewells.push(bwMarker);
                        });
                    }

                    // Then add AI-scored recommended markers (yellow)
                    result.results.forEach((site, idx) => {
                        const iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png';
                        const m = L.marker([site.lat, site.lon], {
                            icon: L.icon({
                                iconUrl: iconUrl,
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).addTo(map);

                        // Build detailed popup with AI explanation
                        let popupContent = `<div style="text-align: left; min-width: 220px;">`;
                        popupContent += `<div style="background: linear-gradient(135deg, #EAB308 0%, #F59E0B 100%); color: white; padding: 8px; border-radius: 8px 8px 0 0; margin: -10px -10px 8px -10px; text-align: center;">
                            <strong style="font-size: 16px;">🤖 AI RANK #${idx + 1}</strong>
                        </div>`;
                        popupContent += `<strong>Success Probability:</strong> ${(site.prob_success * 100).toFixed(1)}%<br>`;
                        if (site.score !== undefined && site.score !== null) {
                            popupContent += `<strong>Adjusted AI Score:</strong> ${(site.score * 100).toFixed(1)}%<br>`;
                        }
                        popupContent += `<strong>Location:</strong> ${site.lat.toFixed(5)}, ${site.lon.toFixed(5)}<br>`;
                        
                        // Find nearest existing borewell
                        if (result.existing_borewells && result.existing_borewells.length > 0) {
                            let nearestBorewell = null;
                            let minDistance = Infinity;
                            
                            result.existing_borewells.forEach((bw) => {
                                const R = 6371000; // Earth radius in meters
                                const lat1 = site.lat * Math.PI / 180;
                                const lat2 = bw.lat * Math.PI / 180;
                                const dLat = (bw.lat - site.lat) * Math.PI / 180;
                                const dLon = (bw.lon - site.lon) * Math.PI / 180;
                                
                                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                                        Math.cos(lat1) * Math.cos(lat2) *
                                        Math.sin(dLon/2) * Math.sin(dLon/2);
                                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                                const distance = R * c;
                                
                                if (distance < minDistance) {
                                    minDistance = distance;
                                    nearestBorewell = bw;
                                }
                            });
                            
                            if (nearestBorewell) {
                                popupContent += `<hr style="margin: 8px 0;">`;
                                popupContent += `<div style="background: #FEF3C7; padding: 6px; border-radius: 4px; margin: 4px 0; border-left: 3px solid #F59E0B;">`;
                                popupContent += `<strong style="color: #92400E;">🏗️ Nearest Existing Borewell:</strong><br>`;
                                popupContent += `<span style="font-size: 12px;">`;
                                popupContent += `📍 <strong>${nearestBorewell.location}</strong><br>`;
                                popupContent += `📏 Distance: <strong style="color: #B45309;">${(minDistance).toFixed(0)}m</strong> (${(minDistance/1000).toFixed(2)}km)<br>`;
                                popupContent += `📊 Status: <span style="color: ${nearestBorewell.status === 'Success' ? '#10B981' : '#EF4444'}; font-weight: bold;">${nearestBorewell.status}</span><br>`;
                                popupContent += `⚙️ Depth: ${nearestBorewell.depth}m | 💧 Yield: ${nearestBorewell.yield} LPH`;
                                popupContent += `</span></div>`;
                            }
                        }
                        
                        // Recommended Depth
                        if (site.recommended_depth !== undefined && site.recommended_depth !== null) {
                            popupContent += `<hr style="margin: 8px 0;">`;
                            popupContent += `<div style="background: #DBEAFE; padding: 6px; border-radius: 4px; margin: 4px 0;">`;
                            popupContent += `<strong style="color: #1E40AF;">⚙️ Recommended Depth:</strong><br>`;
                            popupContent += `<span style="font-size: 18px; font-weight: bold; color: #1E3A8A;">${site.recommended_depth.toFixed(1)}m</span>`;
                            popupContent += `<br><span style="font-size: 11px; color: #6B7280;">Based on nearby successful borewells</span>`;
                            popupContent += `</div>`;
                        }
                        
                        // Evidence from PDF (RAG)
                        if (site.evidence) {
                            popupContent += `<div style="background: #ECFEFF; padding: 6px; border-radius: 4px; margin: 4px 0; border-left: 3px solid #06B6D4;">`;
                            popupContent += `<strong style=\"color: #155E75;\">📚 Evidence (PDF):</strong><br>`;
                            const trimmed = site.evidence.length > 300 ? site.evidence.slice(0, 300) + '…' : site.evidence;
                            popupContent += `<span style=\"font-size: 12px; color: #0E7490;\">${trimmed}</span>`;
                            popupContent += `</div>`;
                        }

                        // Why this point (AI explanation)
                        if (site.why_text) {
                            popupContent += `<hr style="margin: 8px 0;">`;
                            popupContent += `<div style="background: #F0FDF4; padding: 6px; border-radius: 4px; margin: 4px 0; border-left: 3px solid #10B981;">`;
                            popupContent += `<strong style="color: #065F46;">🧭 Why this point:</strong><br>`;
                            popupContent += `<span style="font-size: 12px; color: #065F46;">${site.why_text}</span>`;
                            popupContent += `</div>`;
                        }

                        // Proximity & density metrics
                        if ((site.nearest_existing_m !== undefined && site.nearest_existing_m !== null && isFinite(site.nearest_existing_m)) ||
                            site.counts_within_500m !== undefined || site.counts_within_1km !== undefined) {
                            popupContent += `<div style="background: #FFFBEB; padding: 6px; border-radius: 4px; margin: 4px 0; border-left: 3px solid #F59E0B;">`;
                            popupContent += `<strong style="color: #92400E;">📏 Proximity & Density:</strong><br>`;
                            if (site.nearest_existing_m !== undefined && site.nearest_existing_m !== null && isFinite(site.nearest_existing_m)) {
                                popupContent += `<span style="font-size: 12px;">Nearest existing borewell: <strong>${Math.round(site.nearest_existing_m)} m</strong></span><br>`;
                            }
                            if (site.counts_within_500m !== undefined) {
                                popupContent += `<span style="font-size: 12px;">Existing borewells within 500m: <strong>${site.counts_within_500m}</strong></span><br>`;
                            }
                            if (site.counts_within_1km !== undefined) {
                                popupContent += `<span style="font-size: 12px;">Existing borewells within 1km: <strong>${site.counts_within_1km}</strong></span>`;
                            }
                            popupContent += `</div>`;
                        }
                        
                        if (site.meta) {
                            popupContent += `<hr style="margin: 8px 0;">`;
                            popupContent += `<strong>📊 Nearby Data:</strong><br>`;
                            if (site.meta.avg_depth !== undefined) popupContent += `• Avg Depth: ${site.meta.avg_depth.toFixed(1)}m<br>`;
                            if (site.meta.avg_yield !== undefined) popupContent += `• Avg Yield: ${site.meta.avg_yield.toFixed(0)} LPH<br>`;
                            if (site.meta.success_rate !== undefined) popupContent += `• Success Rate: ${(site.meta.success_rate * 100).toFixed(0)}%<br>`;
                            if (site.meta.count !== undefined) popupContent += `• Nearby Wells: ${site.meta.count}<br>`;
                        }
                        
                        // Distances to other recommended points
                        if (site.distances_to_others && Object.keys(site.distances_to_others).length > 0) {
                            popupContent += `<hr style="margin: 8px 0;">`;
                            popupContent += `<strong>📏 Distance to Other Points:</strong><br>`;
                            popupContent += `<div style="font-size: 11px; max-height: 80px; overflow-y: auto;">`;
                            for (const [point, dist] of Object.entries(site.distances_to_others)) {
                                const pointNum = point.replace('point_', '');
                                popupContent += `• To Point #${pointNum}: <strong>${dist}m</strong><br>`;
                            }
                            popupContent += `</div>`;
                        }
                        
                        if (site.factors && site.factors.length > 0) {
                            popupContent += `<hr style="margin: 8px 0;">`;
                            popupContent += `<strong>🔬 Top Factors:</strong><br>`;
                            popupContent += `<div style="font-size: 12px;">`;
                            site.factors.forEach(f => {
                                const color = f.direction === 'positive' ? '#10B981' : '#EF4444';
                                const sign = f.impact >= 0 ? '+' : '';
                                const arrow = f.direction === 'positive' ? '↑' : '↓';
                                popupContent += `• ${f.feature}: <span style="color: ${color}; font-weight: bold;">${arrow} ${sign}${f.impact}</span><br>`;
                            });
                            popupContent += `</div>`;
                        }

                        if (site.contributions && Object.keys(site.contributions).length > 0) {
                            popupContent += `<hr style="margin: 8px 0;">`;
                            popupContent += `<strong>🧠 AI Feature Contributions:</strong><br>`;
                            popupContent += `<div style="font-size: 11px;">`;
                            for (const [feat, val] of Object.entries(site.contributions)) {
                                if (val !== undefined && val !== null) {
                                    const sign = val >= 0 ? '+' : '';
                                    const color = val >= 0 ? '#10B981' : '#EF4444';
                                    popupContent += `• ${feat}: <span style="color: ${color}; font-weight: bold;">${sign}${val.toFixed(3)}</span><br>`;
                                }
                            }
                            popupContent += `</div>`;
                        }
                        popupContent += `</div>`;

                        m.bindPopup(popupContent);
                        window.aiMarkers.push(m);
                    });

                    statusEl.innerHTML = `
                        <div style="background: #FEF9C3; border: 2px solid #EAB308; border-radius: 8px; padding: 12px; margin-top: 8px;">
                            <div style="font-size: 16px; font-weight: bold; color: #854D0E; margin-bottom: 8px;">
                                🤖 AI Analysis Complete: Top ${result.results.length} Sites
                            </div>
                            ${result.existing_borewells && result.existing_borewells.length > 0 ? `
                                <div style="background: #F3E8FF; border-left: 4px solid #9333EA; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                    <strong style="color: #581C87;">🏗️ Existing Borewells Found:</strong> ${result.existing_borewells.length}<br>
                                    <span style="font-size: 12px; color: #6B21A8;">
                                        🟣 Purple = Success | 🔴 Red = Failed<br>
                                        Success Rate: ${((result.existing_borewells.filter(b => b.status === 'Success').length / result.existing_borewells.length) * 100).toFixed(0)}%
                                    </span>
                                </div>
                            ` : ''}
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: left;">
                                ${result.results.slice(0, 3).map((site, idx) => `
                                    <div style="margin: 6px 0; padding: 8px; background: #FEFCE8; border-radius: 4px; border-left: 4px solid #EAB308;">
                                        <strong>#${idx + 1}: ${(site.prob_success * 100).toFixed(1)}% success</strong>
                                        <span style="color: #6B7280; font-size: 12px;">(${site.lat.toFixed(4)}, ${site.lon.toFixed(4)})</span><br>
                                        ${site.recommended_depth !== undefined && site.recommended_depth !== null ? 
                                            `<span style="color: #854D0E; font-size: 12px;">⚙️ Recommended Depth: <strong>${site.recommended_depth.toFixed(1)}m</strong></span>` : 
                                            ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div style="margin-top: 8px; padding: 8px; background: #E0E7FF; border-radius: 4px; font-size: 12px;">
                                💡 <strong>Legend:</strong><br>
                                🟡 Yellow = AI Recommended Sites | ${result.existing_borewells && result.existing_borewells.length > 0 ? '🟣 Purple (Success) / 🔴 Red (Failed) = Existing Borewells' : 'No existing borewells in this area'}
                            </div>
                        </div>
                    `;
                } else {
                    statusEl.innerHTML = `<div style="color: #EF4444;">❌ Error: ${result.error}</div>`;
                }
            } catch (error) {
                statusEl.innerHTML = `<div style="color: #EF4444;">❌ Error: ${error.message}</div>`;
            }
        });

        // Function to auto-load borewells within 20km radius for specific location
        async function autoLoadNearbyBorewells(lat, lon, locationName = 'this area') {
            console.log('🏗️ Auto-loading borewells for:', locationName, lat, lon);
            // Clear existing borewells first
            if (borewellsVisible) {
                borewellMarkers.forEach(m => map.removeLayer(m));
                borewellMarkers = [];
            }
            
            const statusEl = document.getElementById('borewellStatus');
            statusEl.innerHTML = `<span class="text-purple-600">⏳ Auto-loading borewells near ${locationName}...</span>`;
            statusEl.classList.remove('hidden');
            
            try {
                const response = await fetch('/get_borewells', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lat: lat,
                        lon: lon,
                        radius: 20  // 20km radius for auto-load
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.borewells.length > 0) {
                    const stats = result.statistics;
                    
                    // Display each borewell on map
                    result.borewells.forEach(bw => {
                        let iconUrl, iconColor;
                        
                        // Different colors for successful/failed borewells
                        if (bw.status === 'Success') {
                            iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png';
                            iconColor = '#9333EA'; // Purple
                        } else {
                            iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png';
                            iconColor = '#6B7280'; // Gray
                        }
                        
                        const bwMarker = L.marker([bw.lat, bw.lon], {
                            icon: L.icon({
                                iconUrl: iconUrl,
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).addTo(map);
                        
                        // Enhanced popup with full borewell details
                        let popupContent = `
                            <div style="min-width: 200px;">
                                <div style="background: ${bw.status === 'Success' ? 'linear-gradient(135deg, #9333EA 0%, #7C3AED 100%)' : '#6B7280'}; 
                                            color: white; padding: 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0;">
                                    <strong style="font-size: 16px;">🏗️ ${bw.id}</strong><br>
                                    <span style="font-size: 12px;">${bw.location}</span>
                                </div>
                                
                                <table style="width: 100%; font-size: 13px;">
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Status:</td>
                                        <td style="padding: 4px;">
                                            <span style="background: ${bw.status === 'Success' ? '#10B981' : '#EF4444'}; 
                                                         color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                                ${bw.status}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Depth:</td>
                                        <td style="padding: 4px;">${bw.depth}m</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Yield:</td>
                                        <td style="padding: 4px;">${bw.yield} LPH</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Year:</td>
                                        <td style="padding: 4px;">${bw.year}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Quality:</td>
                                        <td style="padding: 4px;">${bw.quality}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Taluka:</td>
                                        <td style="padding: 4px;">${bw.taluka}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; font-weight: bold;">Distance:</td>
                                        <td style="padding: 4px;">${bw.distance} km</td>
                                    </tr>
                                </table>
                                
                                <div style="margin-top: 10px; font-size: 11px; color: #6B7280;">
                                    📍 ${bw.lat.toFixed(4)}, ${bw.lon.toFixed(4)}
                                </div>
                            </div>
                        `;
                        
                        bwMarker.bindPopup(popupContent);
                        borewellMarkers.push(bwMarker);
                    });
                    
                    // Display statistics
                    statusEl.innerHTML = `
                        <div style="background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%); border: 2px solid #9333EA; border-radius: 8px; padding: 12px; margin-top: 8px; box-shadow: 0 2px 8px rgba(147, 51, 234, 0.15);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <strong style="color: #7C3AED; font-size: 15px;">🏗️ CGWB Borewells Near ${locationName}</strong>
                                <span style="background: #10B981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">AUTO-LOADED</span>
                            </div>
                            <div style="margin-top: 8px; font-size: 13px; color: #4C1D95;">
                                <strong>Found ${stats.total} borewells within ${result.radius_km}km radius</strong><br>
                                ✅ Successful: <strong style="color: #10B981;">${stats.successful}</strong> | 
                                ❌ Failed: <strong style="color: #EF4444;">${stats.failed}</strong> | 
                                Success Rate: <strong>${stats.success_rate}%</strong><br>
                                📊 Avg Depth: <strong>${stats.avg_depth}m</strong> | 
                                Avg Yield: <strong>${stats.avg_yield} LPH</strong><br>
                                📏 Depth Range: ${stats.min_depth}m - ${stats.max_depth}m
                            </div>
                        </div>
                    `;
                    
                    borewellsVisible = true;
                    document.getElementById('showBorewellsBtn').classList.add('hidden');
                    document.getElementById('hideBorewellsBtn').classList.remove('hidden');
                    
                    return true;
                } else {
                    statusEl.innerHTML = `<span class="text-yellow-600">⚠️ No borewells found within 20km of ${locationName}</span>`;
                    return false;
                }
                
            } catch (error) {
                statusEl.innerHTML = `<span class="text-red-600">❌ Error loading borewells: ${error.message}</span>`;
                return false;
            }
        }
        
        // Function to fetch and display borewells (manual button click - 50km radius)
        async function loadBorewells() {
            const statusEl = document.getElementById('borewellStatus');
            const center = map.getCenter();
            
            statusEl.innerHTML = '<span class="text-purple-600">⏳ Loading existing borewells...</span>';
            statusEl.classList.remove('hidden');
            
            try {
                const response = await fetch('/get_borewells', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lat: center.lat,
                        lon: center.lng,
                        radius: 50  // 50km radius for manual search
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.borewells.length > 0) {
                    const stats = result.statistics;
                    
                    // Display each borewell on map
                    result.borewells.forEach(bw => {
                        let iconUrl, iconColor;
                        
                        // Different colors for successful/failed borewells
                        if (bw.status === 'Success') {
                            iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png';
                            iconColor = '#9333EA'; // Purple
                        } else {
                            iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png';
                            iconColor = '#6B7280'; // Gray
                        }
                        
                        const bwMarker = L.marker([bw.lat, bw.lon], {
                            icon: L.icon({
                                iconUrl: iconUrl,
                                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                shadowSize: [41, 41]
                            })
                        }).addTo(map);
                        
                        // Enhanced popup with full borewell details
                        let popupContent = `
                            <div style="min-width: 200px;">
                                <div style="background: ${bw.status === 'Success' ? 'linear-gradient(135deg, #9333EA 0%, #7C3AED 100%)' : '#6B7280'}; 
                                            color: white; padding: 10px; margin: -10px -10px 10px -10px; border-radius: 8px 8px 0 0;">
                                    <strong style="font-size: 16px;">🏗️ ${bw.id}</strong><br>
                                    <span style="font-size: 12px;">${bw.location}</span>
                                </div>
                                
                                <table style="width: 100%; font-size: 13px;">
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Status:</td>
                                        <td style="padding: 4px;">
                                            <span style="background: ${bw.status === 'Success' ? '#10B981' : '#EF4444'}; 
                                                         color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                                ${bw.status}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Depth:</td>
                                        <td style="padding: 4px;">${bw.depth}m</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Yield:</td>
                                        <td style="padding: 4px;">${bw.yield} LPH</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Year:</td>
                                        <td style="padding: 4px;">${bw.year}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Quality:</td>
                                        <td style="padding: 4px;">${bw.quality}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                        <td style="padding: 4px; font-weight: bold;">Taluka:</td>
                                        <td style="padding: 4px;">${bw.taluka}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 4px; font-weight: bold;">Distance:</td>
                                        <td style="padding: 4px;">${bw.distance} km</td>
                                    </tr>
                                </table>
                                
                                <div style="margin-top: 10px; font-size: 11px; color: #6B7280;">
                                    📍 ${bw.lat.toFixed(4)}, ${bw.lon.toFixed(4)}
                                </div>
                            </div>
                        `;
                        
                        bwMarker.bindPopup(popupContent);
                        borewellMarkers.push(bwMarker);
                    });
                    
                    // Display statistics
                    statusEl.innerHTML = `
                        <div style="background: #F5F3FF; border: 2px solid #9333EA; border-radius: 8px; padding: 12px; margin-top: 8px;">
                            <strong style="color: #7C3AED; font-size: 15px;">🏗️ CGWB Borewell Database</strong><br>
                            <div style="margin-top: 8px; font-size: 13px;">
                                <strong>Found ${stats.total} borewells within ${result.radius_km}km</strong><br>
                                ✅ Successful: <strong style="color: #10B981;">${stats.successful}</strong> | 
                                ❌ Failed: <strong style="color: #EF4444;">${stats.failed}</strong> | 
                                Success Rate: <strong>${stats.success_rate}%</strong><br>
                                📊 Avg Depth: <strong>${stats.avg_depth}m</strong> | 
                                Avg Yield: <strong>${stats.avg_yield} LPH</strong><br>
                                📏 Depth Range: ${stats.min_depth}m - ${stats.max_depth}m
                            </div>
                        </div>
                    `;
                    
                    borewellsVisible = true;
                    document.getElementById('showBorewellsBtn').classList.add('hidden');
                    document.getElementById('hideBorewellsBtn').classList.remove('hidden');
                    
                } else {
                    statusEl.innerHTML = '<span class="text-yellow-600">⚠️ No borewells found in this area</span>';
                }
                
            } catch (error) {
                statusEl.innerHTML = `<span class="text-red-600">❌ Error loading borewells: ${error.message}</span>`;
            }
        }

        // Function to hide borewells
        function hideBorewells() {
            borewellMarkers.forEach(m => map.removeLayer(m));
            borewellMarkers = [];
            borewellsVisible = false;
            
            document.getElementById('borewellStatus').classList.add('hidden');
            document.getElementById('showBorewellsBtn').classList.remove('hidden');
            document.getElementById('hideBorewellsBtn').classList.add('hidden');
        }

        // Show Borewells Button Handler
        document.getElementById('showBorewellsBtn').addEventListener('click', loadBorewells);

        // Hide Borewells Button Handler
        document.getElementById('hideBorewellsBtn').addEventListener('click', hideBorewells);

        // Weather Data Functions
        async function loadWeatherData(lat, lon) {
            console.log('🌦️ Loading weather data for:', lat, lon);
            try {
                const response = await fetch('/get_weather_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: lat, lon: lon })
                });

                const result = await response.json();
                console.log('✅ Weather response:', result);

                if (result.success) {
                    const weather = result.current_weather;
                    const stations = result.nearest_stations;
                    
                    // Show weather panel
                    document.getElementById('weatherPanel').classList.remove('hidden');
                    
                    // Update current weather
                    document.getElementById('weatherRainfall').textContent = weather.rainfall.toFixed(1);
                    document.getElementById('weatherTemp').textContent = weather.temperature.toFixed(1);
                    document.getElementById('weatherRiver').textContent = weather.river_water_level.toFixed(2);
                    document.getElementById('weatherSeason').textContent = weather.season.toUpperCase() + ' (' + weather.month_name + ')';
                    document.getElementById('weatherTimestamp').textContent = weather.timestamp;
                    
                    // Show nearest stations
                    if (stations && stations.length > 0) {
                        const stationsPanel = document.getElementById('nearestStations');
                        const stationsList = document.getElementById('stationsList');
                        
                        stationsList.innerHTML = stations.map(station => `
                            <div class="flex justify-between items-center py-1">
                                <span><strong>${station.name}</strong></span>
                                <span class="text-xs text-gray-500">${station.distance_km} km</span>
                            </div>
                            <div class="text-xs text-gray-500 mb-2">${station.type}</div>
                        `).join('');
                        
                        stationsPanel.classList.remove('hidden');
                    }
                } else {
                    console.error('Failed to load weather data:', result.error);
                }
            } catch (error) {
                console.error('Error loading weather data:', error);
            }
        }

        // Recommendation functions removed - Feature disabled

                // ============================================
                // RAG CHATBOT FUNCTIONALITY
                // ============================================

                document.addEventListener('DOMContentLoaded', function() {
                    // Add pulse animation to language selector for first 6 seconds
                    setTimeout(function() {
                        const desktopTranslate = document.querySelector('#google_translate_element');
                        const mobileTranslate = document.querySelector('#google_translate_element_mobile');
                        
                        if (desktopTranslate) {
                            const desktopSelect = desktopTranslate.querySelector('select');
                            if (desktopSelect) {
                                desktopSelect.classList.add('language-selector-pulse');
                                setTimeout(() => desktopSelect.classList.remove('language-selector-pulse'), 6000);
                            }
                        }
                        
                        if (mobileTranslate) {
                            const mobileSelect = mobileTranslate.querySelector('select');
                            if (mobileSelect) {
                                mobileSelect.classList.add('language-selector-pulse');
                                setTimeout(() => mobileSelect.classList.remove('language-selector-pulse'), 6000);
                            }
                        }
                    }, 1000); // Wait 1 second for Google Translate to load
                    
                    const openBtn = document.getElementById('ragChatbotBtn');
                    const modal = document.getElementById('ragChatbotModal');
                    const closeBtn = document.getElementById('closeRagModal');
                    const uploadBtn = document.getElementById('uploadPdfBtn');
                    const fileInput = document.getElementById('pdfFileInput');
                    const statusEl = document.getElementById('uploadStatus');

                    // Guard: elements may not exist if feature hidden
                    if (!modal) {
                        console.warn('RAG modal not found in DOM');
                        return;
                    }

                    if (openBtn) {
                        openBtn.addEventListener('click', function() {
                            modal.classList.remove('hidden');
                            // Attach chat handlers after modal opens
                            setTimeout(attachChatHandlers, 200);
                        });
                    }

                    if (closeBtn) {
                        closeBtn.addEventListener('click', function() {
                            modal.classList.add('hidden');
                        });
                    }

                    // Close on backdrop click
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) modal.classList.add('hidden');
                    });

                    // Ensure upload button is type=button to prevent form submit
                    if (uploadBtn && !uploadBtn.getAttribute('type')) {
                        uploadBtn.setAttribute('type', 'button');
                    }

                                        if (uploadBtn) uploadBtn.addEventListener('click', async function() {
                                            console.log('📄 Upload PDF button clicked');
                                            const file = fileInput ? fileInput.files[0] : null;
                                            if (!file) {
                                                alert('⚠️ Please select a PDF file first');
                                                return;
                                            }
                                            // client-side 16MB size check
                                            const maxSize = 16 * 1024 * 1024;
                                            if (file.size > maxSize) {
                                                statusEl.textContent = '❌ File too large. Max 16MB allowed.';
                                                statusEl.className = 'mt-2 text-red-600 text-sm font-medium';
                                                return;
                                            }
                                            console.log('📄 File selected:', file.name, 'Size:', file.size, 'bytes');
                                            statusEl.textContent = '⏳ Uploading and processing PDF...';
                                            statusEl.className = 'mt-2 text-blue-600 text-sm font-medium';
                                            this.disabled = true;
                                            this.textContent = '⏳ Processing...';
                                            const formData = new FormData();
                                            formData.append('pdf_file', file);
                                            formData.append('session_id', 'default');
                                            try {
                                                console.log('📤 Sending PDF to server...');
                                                const controller = new AbortController();
                                                const timeout = setTimeout(() => controller.abort(), 120000);
                                                const response = await fetch('/upload_pdf', { method: 'POST', body: formData, signal: controller.signal });
                                                clearTimeout(timeout);
                                                console.log('📥 Server response status:', response.status);
                                                const result = await response.json();
                                                console.log('📥 Server response:', result);
                                                if (result.success) {
                                                    statusEl.textContent = `✅ ${result.message}`;
                                                    statusEl.className = 'mt-2 text-green-600 text-sm font-medium';
                                                    document.getElementById('chatSection').classList.remove('hidden');
                                                    document.getElementById('chatMessages').innerHTML = `
                                                        <div class="text-center py-4 text-gray-500">
                                                            📄 Document loaded: <strong>${result.filename}</strong> (${result.num_pages} pages)<br>
                                                            💬 Ask me anything about the document!
                                                        </div>
                                                    `;
                                                    // Re-attach chat handlers after chat section appears
                                                    setTimeout(attachChatHandlers, 100);
                                                } else {
                                                    statusEl.textContent = `❌ Error: ${result.error}`;
                                                    statusEl.className = 'mt-2 text-red-600 text-sm font-medium';
                                                }
                                            } catch (error) {
                                                console.error('❌ Upload error:', error);
                                                const msg = (error && error.name === 'AbortError') ? 'Request timed out. Please try again.' : (error && error.message ? error.message : 'Failed to upload');
                                                statusEl.textContent = `❌ Error: ${msg}`;
                                                statusEl.className = 'mt-2 text-red-600 text-sm font-medium';
                                            } finally {
                                                this.disabled = false;
                                                this.textContent = '📄 Process PDF';
                                            }
                                        });
                });

                                // Fallback: if script injected after DOM ready
                                if (document.readyState !== 'loading') {
                                    try { const evt = new Event('DOMContentLoaded'); document.dispatchEvent(evt); } catch (_) {}
                                }

        // Send Question function
        async function sendQuestion() {
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            
            if (!question) return;
            
            const chatMessages = document.getElementById('chatMessages');
            
            // Add user message
            chatMessages.innerHTML += `
                <div class="flex justify-end mb-4">
                    <div class="bg-blue-500 text-white rounded-2xl rounded-tr-none px-4 py-3 max-w-[80%]">
                        <div class="font-semibold text-xs mb-1">You</div>
                        <div>${question}</div>
                    </div>
                </div>
            `;
            
            questionInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Show loading
            const loadingId = 'loading-' + Date.now();
            chatMessages.innerHTML += `
                <div id="${loadingId}" class="flex justify-start mb-4">
                    <div class="bg-gray-200 rounded-2xl rounded-tl-none px-4 py-3 max-w-[80%]">
                        <div class="font-semibold text-xs mb-1 text-gray-700">AI Assistant</div>
                        <div class="text-gray-600">⏳ Thinking...</div>
                    </div>
                </div>
            `;
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                // Timeout controller to avoid hanging requests
                const controller = new AbortController();
                const timeoutMs = 45000; // 45s timeout
                const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                const response = await fetch('/ask_rag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        session_id: 'default'
                    }),
                    signal: controller.signal
                });
                
                const result = await response.json();
                clearTimeout(timeoutId);
                
                // Remove loading
                document.getElementById(loadingId).remove();
                
                if (result.success) {
                    // Add AI response
                    chatMessages.innerHTML += `
                        <div class="flex justify-start mb-4">
                            <div class="bg-gradient-to-br from-purple-50 to-blue-50 border border-purple-200 rounded-2xl rounded-tl-none px-4 py-3 max-w-[80%]">
                                <div class="font-semibold text-xs mb-1 text-purple-700">🤖 AI Assistant</div>
                                <div class="text-gray-800 whitespace-pre-wrap">${result.answer}</div>
                            </div>
                        </div>
                    `;
                } else {
                    chatMessages.innerHTML += `
                        <div class="flex justify-start mb-4">
                            <div class="bg-red-50 border border-red-200 rounded-2xl rounded-tl-none px-4 py-3 max-w-[80%]">
                                <div class="font-semibold text-xs mb-1 text-red-700">❌ Error</div>
                                <div class="text-red-600">${result.error}</div>
                            </div>
                        </div>
                    `;
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                document.getElementById(loadingId).remove();
                const msg = (error && (error.name === 'AbortError')) ? `Request timed out after 45s` : error.message;
                chatMessages.innerHTML += `
                    <div class="flex justify-start mb-4">
                        <div class="bg-red-50 border border-red-200 rounded-2xl rounded-tl-none px-4 py-3 max-w-[80%]">
                            <div class="font-semibold text-xs mb-1 text-red-700">❌ Error</div>
                            <div class="text-red-600">${msg}</div>
                        </div>
                    </div>
                `;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Attach Send and Clear button handlers after DOM is ready
        function attachChatHandlers() {
            const sendBtn = document.getElementById('sendQuestionBtn');
            const clearBtn = document.getElementById('clearChatBtn');
            const questionInput = document.getElementById('questionInput');
            
            if (!sendBtn || !clearBtn || !questionInput) {
                console.error('❌ Chat buttons not found in DOM');
                return;
            }
            
            // Remove any existing listeners by cloning
            const newSendBtn = sendBtn.cloneNode(true);
            sendBtn.parentNode.replaceChild(newSendBtn, sendBtn);
            
            const newClearBtn = clearBtn.cloneNode(true);
            clearBtn.parentNode.replaceChild(newClearBtn, clearBtn);
            
            const newInput = questionInput.cloneNode(true);
            questionInput.parentNode.replaceChild(newInput, questionInput);
            
            // Attach fresh listeners
            newSendBtn.addEventListener('click', async function() {
                console.log('✅ Send button clicked');
                await sendQuestion();
            });
            
            newInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    console.log('✅ Enter key pressed');
                    sendQuestion();
                }
            });
            
            newClearBtn.addEventListener('click', async function() {
                console.log('✅ Clear button clicked');
                if (!confirm('Are you sure you want to clear the chat history?')) return;
                
                try {
                    const response = await fetch('/clear_chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: 'default' })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        document.getElementById('chatMessages').innerHTML = `
                            <div class="text-center py-4 text-gray-500">
                                💬 Chat cleared! Ask me anything about the document.
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error clearing chat:', error);
                }
            });
            
            console.log('✅ Chat handlers attached successfully');
        }
        
    </script>

    <!-- RAG Chatbot Modal -->
    <div id="ragChatbotModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white p-6 rounded-t-2xl flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold">💬 AI Document Chat</h2>
                    <p class="text-blue-100 text-sm mt-1">Upload PDF and ask questions using RAG AI</p>
                </div>
                <button id="closeRagModal" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Body -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Upload Section -->
                <div class="mb-6 bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-xl p-4">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        Upload PDF Document
                    </h3>
                    <input type="file" id="pdfFileInput" accept=".pdf" class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 mb-3">
                    <button id="uploadPdfBtn" type="button" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-3 px-6 rounded-xl hover:from-blue-700 hover:to-cyan-700 transition font-semibold">
                        📄 Process PDF
                    </button>
                    <div id="uploadStatus" class="mt-2"></div>
                </div>
                
                <!-- Chat Section -->
                <div id="chatSection" class="hidden">
                    <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-4 mb-4 max-h-96 overflow-y-auto" id="chatMessages">
                        <div class="text-center py-4 text-gray-500">
                            💬 Upload a PDF to start chatting!
                        </div>
                    </div>
                    
                    <!-- Input Section -->
                    <div class="flex gap-2">
                        <input type="text" id="questionInput" placeholder="Ask a question about the document..." class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-blue-500">
                        <button id="sendQuestionBtn" class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition font-semibold">
                            Send
                        </button>
                        <button id="clearChatBtn" class="bg-gray-200 text-gray-700 px-4 py-3 rounded-xl hover:bg-gray-300 transition">
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>